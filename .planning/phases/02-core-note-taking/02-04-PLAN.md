---
phase: 02-core-note-taking
plan: 04
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - apps/mobile/package.json
  - apps/mobile/src/utils/markdown.ts
  - apps/mobile/src/components/editor/NoteEditor.tsx
  - apps/mobile/src/components/editor/EditorToolbar.tsx
  - apps/mobile/src/components/editor/index.ts
autonomous: true

must_haves:
  truths:
    - "User sees rich text WYSIWYG editor (not raw markdown)"
    - "Editor loads existing note content from markdown"
    - "Editor saves content as markdown (not HTML)"
    - "Toolbar provides formatting options (bold, italic, headers, lists)"
    - "Keyboard avoidance works on iOS"
  artifacts:
    - path: "apps/mobile/src/components/editor/NoteEditor.tsx"
      provides: "10tap-editor wrapper component"
      exports: ["NoteEditor"]
    - path: "apps/mobile/src/utils/markdown.ts"
      provides: "Markdown conversion utilities"
      exports: ["markdownToHtml", "htmlToMarkdown"]
  key_links:
    - from: "apps/mobile/src/components/editor/NoteEditor.tsx"
      to: "@10play/tentap-editor"
      via: "useEditorBridge"
      pattern: "useEditorBridge"
    - from: "apps/mobile/src/utils/markdown.ts"
      to: "turndown/showdown"
      via: "import"
      pattern: "from 'turndown'|from 'showdown'"
---

<objective>
Create the note editor component using 10tap-editor with markdown conversion for storage.

Purpose: Provide a rich text WYSIWYG editing experience while storing content as markdown. Users edit with formatting visible (like Google Docs) but data persists as markdown (portable, searchable).

Output: NoteEditor component that wraps 10tap-editor, with markdown-to-HTML on load and HTML-to-markdown on save.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-note-taking/02-02-SUMMARY.md
@apps/mobile/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install 10tap-editor and markdown conversion dependencies</name>
  <files>
    apps/mobile/package.json
  </files>
  <action>
Install 10tap-editor and its dependencies:

```bash
pnpm --filter @k7notes/mobile add @10play/tentap-editor react-native-webview
pnpm --filter @k7notes/mobile add turndown showdown
pnpm --filter @k7notes/mobile add -D @types/turndown @types/showdown
```

IMPORTANT: react-native-webview is a peer dependency of 10tap-editor. Must be installed.

After installation, verify versions:
```bash
pnpm --filter @k7notes/mobile list @10play/tentap-editor react-native-webview turndown showdown
```

Note: 10tap-editor is based on Tiptap/Prosemirror and renders in a WebView. This is the recommended approach for rich text on React Native.
  </action>
  <verify>
Run `pnpm --filter @k7notes/mobile list @10play/tentap-editor` confirms package installed.
Run `pnpm --filter @k7notes/mobile type-check` passes.
  </verify>
  <done>10tap-editor, react-native-webview, turndown, showdown installed</done>
</task>

<task type="auto">
  <name>Task 2: Create markdown conversion utilities</name>
  <files>
    apps/mobile/src/utils/markdown.ts
    apps/mobile/src/utils/index.ts
  </files>
  <action>
Create apps/mobile/src/utils/markdown.ts:

```typescript
import TurndownService from 'turndown';
import Showdown from 'showdown';

// HTML to Markdown converter (for saving)
const turndownService = new TurndownService({
  headingStyle: 'atx',        // Use # for headings
  codeBlockStyle: 'fenced',   // Use ``` for code blocks
  bulletListMarker: '-',      // Use - for bullet lists
});

// Configure turndown for better markdown output
turndownService.addRule('strikethrough', {
  filter: ['del', 's', 'strike'],
  replacement: (content) => `~~${content}~~`,
});

// Markdown to HTML converter (for loading)
const showdownConverter = new Showdown.Converter({
  tables: true,
  tasklists: true,
  strikethrough: true,
  ghCodeBlocks: true,
  emoji: true,
  simpleLineBreaks: true,
});

/**
 * Convert markdown to HTML for display in 10tap-editor
 */
export function markdownToHtml(markdown: string): string {
  if (!markdown) return '<p></p>';
  return showdownConverter.makeHtml(markdown);
}

/**
 * Convert HTML from 10tap-editor to markdown for storage
 */
export function htmlToMarkdown(html: string): string {
  if (!html || html === '<p></p>' || html === '<p><br></p>') return '';
  return turndownService.turndown(html);
}

/**
 * Check if content is empty (handles various empty states from editor)
 */
export function isContentEmpty(html: string | null | undefined): boolean {
  if (!html) return true;
  const trimmed = html.trim();
  return (
    trimmed === '' ||
    trimmed === '<p></p>' ||
    trimmed === '<p><br></p>' ||
    trimmed === '<p><br/></p>'
  );
}
```

Create apps/mobile/src/utils/index.ts:
```typescript
export * from './markdown';
```
  </action>
  <verify>
Run `pnpm --filter @k7notes/mobile type-check` passes.
  </verify>
  <done>Markdown conversion utilities created with markdownToHtml and htmlToMarkdown</done>
</task>

<task type="auto">
  <name>Task 3: Create NoteEditor component with 10tap-editor</name>
  <files>
    apps/mobile/src/components/editor/NoteEditor.tsx
    apps/mobile/src/components/editor/EditorToolbar.tsx
    apps/mobile/src/components/editor/index.ts
  </files>
  <action>
Create apps/mobile/src/components/editor/NoteEditor.tsx:

```typescript
import React, { useCallback, useEffect, useImperativeHandle, forwardRef } from 'react';
import { StyleSheet, View, KeyboardAvoidingView, Platform } from 'react-native';
import {
  RichText,
  Toolbar,
  useEditorBridge,
  TenTapStartKit,
  CoreBridge,
} from '@10play/tentap-editor';
import { markdownToHtml, htmlToMarkdown } from '@/utils/markdown';

export interface NoteEditorRef {
  getMarkdown: () => Promise<string>;
  setMarkdown: (markdown: string) => void;
  focus: () => void;
}

export interface NoteEditorProps {
  initialContent?: string; // Markdown content
  onContentChange?: (markdown: string) => void;
  editable?: boolean;
  placeholder?: string;
}

export const NoteEditor = forwardRef<NoteEditorRef, NoteEditorProps>(
  ({ initialContent = '', onContentChange, editable = true, placeholder }, ref) => {
    const editor = useEditorBridge({
      autofocus: false,
      avoidIosKeyboard: true,
      initialContent: markdownToHtml(initialContent),
      bridgeExtensions: [
        ...TenTapStartKit,
        CoreBridge.configureCSS(`
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #1a1a1a;
            padding: 16px;
          }
          h1 { font-size: 28px; margin: 16px 0 8px; }
          h2 { font-size: 24px; margin: 14px 0 6px; }
          h3 { font-size: 20px; margin: 12px 0 4px; }
          code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Menlo, monospace;
          }
          pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
          }
          blockquote {
            border-left: 3px solid #ddd;
            padding-left: 12px;
            margin-left: 0;
            color: #666;
          }
          ul, ol { padding-left: 24px; }
          .placeholder { color: #999; }
        `),
      ],
    });

    // Expose methods via ref
    useImperativeHandle(ref, () => ({
      getMarkdown: async () => {
        const html = await editor.getHTML();
        return htmlToMarkdown(html);
      },
      setMarkdown: (markdown: string) => {
        editor.setContent(markdownToHtml(markdown));
      },
      focus: () => {
        editor.focus();
      },
    }));

    // Track content changes
    useEffect(() => {
      if (!onContentChange) return;

      const unsubscribe = editor.subscribeToContentUpdate(async () => {
        const html = await editor.getHTML();
        const markdown = htmlToMarkdown(html);
        onContentChange(markdown);
      });

      return () => {
        unsubscribe();
      };
    }, [editor, onContentChange]);

    return (
      <KeyboardAvoidingView
        style={styles.container}
        behavior={Platform.OS === 'ios' ? 'padding' : undefined}
        keyboardVerticalOffset={Platform.OS === 'ios' ? 88 : 0}
      >
        <View style={styles.editorContainer}>
          <RichText editor={editor} />
        </View>
        {editable && (
          <View style={styles.toolbarContainer}>
            <Toolbar editor={editor} />
          </View>
        )}
      </KeyboardAvoidingView>
    );
  }
);

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  editorContainer: {
    flex: 1,
  },
  toolbarContainer: {
    borderTopWidth: 1,
    borderTopColor: '#eee',
    backgroundColor: '#fff',
  },
});
```

Create apps/mobile/src/components/editor/index.ts:
```typescript
export { NoteEditor } from './NoteEditor';
export type { NoteEditorRef, NoteEditorProps } from './NoteEditor';
```

Note: We're using 10tap's built-in Toolbar component initially. A custom EditorToolbar.tsx can be created later if more control is needed. The built-in toolbar provides standard formatting (bold, italic, headers, lists, code, links).
  </action>
  <verify>
Run `pnpm --filter @k7notes/mobile type-check` passes.
  </verify>
  <done>
NoteEditor component created with:
- 10tap-editor integration via useEditorBridge
- Markdown-to-HTML on load, HTML-to-markdown on save
- Ref methods for getMarkdown, setMarkdown, focus
- Built-in Toolbar for formatting
- iOS keyboard avoidance
- Custom CSS styling for rendered content
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @k7notes/mobile type-check` passes
2. All packages installed: @10play/tentap-editor, react-native-webview, turndown, showdown
3. NoteEditor component exports correctly
4. markdownToHtml and htmlToMarkdown functions work (will test in UI plans)
</verification>

<success_criteria>
- 10tap-editor and dependencies installed
- markdownToHtml converts markdown to HTML for editor display
- htmlToMarkdown converts HTML back to markdown for storage
- NoteEditor component renders 10tap RichText editor
- Editor ref provides getMarkdown, setMarkdown, focus methods
- Built-in Toolbar provides formatting options
- Keyboard avoidance configured for iOS
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-note-taking/02-04-SUMMARY.md`
</output>
