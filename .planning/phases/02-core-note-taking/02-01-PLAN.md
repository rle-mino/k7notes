---
phase: 02-core-note-taking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/package.json
  - apps/mobile/metro.config.js
  - apps/mobile/babel.config.js
  - apps/mobile/db/client.ts
  - apps/mobile/db/schema.ts
  - apps/mobile/db/migrations/0001_initial.sql
autonomous: true

must_haves:
  truths:
    - "SQLite database opens without error on app start"
    - "Drizzle ORM connects to expo-sqlite"
    - "Metro bundler loads .sql files as strings"
  artifacts:
    - path: "apps/mobile/db/client.ts"
      provides: "Database connection singleton"
      exports: ["db", "runMigrations"]
    - path: "apps/mobile/db/schema.ts"
      provides: "Drizzle schema with notes and folders tables"
      contains: "notes"
    - path: "apps/mobile/db/migrations/0001_initial.sql"
      provides: "Initial migration SQL"
      contains: "CREATE TABLE"
  key_links:
    - from: "apps/mobile/db/client.ts"
      to: "expo-sqlite"
      via: "openDatabaseSync"
      pattern: "openDatabaseSync"
    - from: "apps/mobile/metro.config.js"
      to: ".sql files"
      via: "resolver.sourceExts"
      pattern: "sourceExts.*sql"
---

<objective>
Set up SQLite database with Drizzle ORM for local-first note storage on Expo mobile app.

Purpose: Establish the persistence layer that all note operations depend on. Local-first architecture requires a robust client-side database before any UI work can begin.

Output: Working expo-sqlite database with Drizzle ORM integration, migrations system, and notes/folders schema ready for CRUD operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/mobile/package.json
@apps/mobile/metro.config.js
@apps/mobile/babel.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure Metro for SQL files</name>
  <files>
    apps/mobile/package.json
    apps/mobile/metro.config.js
    apps/mobile/babel.config.js
  </files>
  <action>
Install required dependencies:
```bash
pnpm --filter @k7notes/mobile add expo-sqlite drizzle-orm
pnpm --filter @k7notes/mobile add -D drizzle-kit babel-plugin-inline-import
```

Update metro.config.js to handle .sql files:
```javascript
const { getDefaultConfig } = require('expo/metro-config');

const config = getDefaultConfig(__dirname);

// Add sql to source extensions for inline-import
config.resolver.sourceExts.push('sql');

module.exports = config;
```

Update babel.config.js to enable inline-import for .sql files:
```javascript
module.exports = function(api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: [
      ['inline-import', { extensions: ['.sql'] }]
    ]
  };
};
```

IMPORTANT: expo-sqlite version must match SDK 52 (~16.0.10). Check with `pnpm --filter @k7notes/mobile list expo-sqlite` after install.
  </action>
  <verify>
Run `pnpm --filter @k7notes/mobile list expo-sqlite drizzle-orm` to confirm packages installed.
Run `pnpm --filter @k7notes/mobile type-check` to confirm no TypeScript errors.
  </verify>
  <done>expo-sqlite ~16.0.x and drizzle-orm installed, Metro configured to load .sql files</done>
</task>

<task type="auto">
  <name>Task 2: Create Drizzle schema and database client</name>
  <files>
    apps/mobile/db/schema.ts
    apps/mobile/db/client.ts
    apps/mobile/db/migrations/0001_initial.sql
  </files>
  <action>
Create apps/mobile/db/schema.ts with notes and folders tables using Drizzle SQLite syntax:

```typescript
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';

// Folders use adjacency list pattern for nesting (parent_id FK)
export const folders = sqliteTable('folders', {
  id: text('id').primaryKey(), // UUID
  name: text('name').notNull(),
  parentId: text('parent_id').references(() => folders.id, { onDelete: 'cascade' }),
  createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
  updatedAt: integer('updated_at', { mode: 'timestamp' }).notNull(),
});

// Notes belong to folders (nullable for root-level notes)
export const notes = sqliteTable('notes', {
  id: text('id').primaryKey(), // UUID
  title: text('title').notNull(),
  content: text('content').notNull().default(''), // Stored as markdown
  folderId: text('folder_id').references(() => folders.id, { onDelete: 'set null' }),
  createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
  updatedAt: integer('updated_at', { mode: 'timestamp' }).notNull(),
});

// Type exports for use in queries
export type Folder = typeof folders.$inferSelect;
export type NewFolder = typeof folders.$inferInsert;
export type Note = typeof notes.$inferSelect;
export type NewNote = typeof notes.$inferInsert;
```

Create apps/mobile/db/migrations/0001_initial.sql with raw SQL (will be imported as string):

```sql
-- Create folders table with adjacency list for nesting
CREATE TABLE IF NOT EXISTS folders (
  id TEXT PRIMARY KEY NOT NULL,
  name TEXT NOT NULL,
  parent_id TEXT REFERENCES folders(id) ON DELETE CASCADE,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- Create notes table
CREATE TABLE IF NOT EXISTS notes (
  id TEXT PRIMARY KEY NOT NULL,
  title TEXT NOT NULL,
  content TEXT NOT NULL DEFAULT '',
  folder_id TEXT REFERENCES folders(id) ON DELETE SET NULL,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- Indexes for common queries
CREATE INDEX IF NOT EXISTS idx_folders_parent_id ON folders(parent_id);
CREATE INDEX IF NOT EXISTS idx_notes_folder_id ON notes(folder_id);
CREATE INDEX IF NOT EXISTS idx_notes_updated_at ON notes(updated_at);
```

Create apps/mobile/db/client.ts:

```typescript
import { drizzle } from 'drizzle-orm/expo-sqlite';
import { openDatabaseSync } from 'expo-sqlite';
import * as schema from './schema';

// Import migration SQL (babel-plugin-inline-import converts to string)
import migration0001 from './migrations/0001_initial.sql';

const expo = openDatabaseSync('k7notes.db', { enableChangeListener: true });

export const db = drizzle(expo, { schema });

// Run migrations on app start
export async function runMigrations() {
  // Simple migration runner - execute each migration SQL
  expo.execSync(migration0001);
  console.log('[DB] Migrations complete');
}

// Export raw expo-sqlite for useLiveQuery if needed
export { expo };
```

Also create apps/mobile/db/index.ts for clean exports:
```typescript
export * from './schema';
export * from './client';
```
  </action>
  <verify>
Run `pnpm --filter @k7notes/mobile type-check` to confirm TypeScript compiles.
Start the app with `pnpm --filter @k7notes/mobile start` and check console for "[DB] Migrations complete" (requires calling runMigrations in app).
  </verify>
  <done>
Drizzle schema defines notes and folders tables with proper types.
Database client exports db instance and runMigrations function.
Migration SQL file creates tables with indexes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Initialize database on app startup and verify</name>
  <files>
    apps/mobile/app/_layout.tsx
  </files>
  <action>
Update apps/mobile/app/_layout.tsx to initialize the database on app startup.

Add database initialization in the root layout before auth check:

```typescript
import { useEffect, useState } from 'react';
import { runMigrations } from '../db';

// Inside RootLayout component, before the auth session check:
const [dbReady, setDbReady] = useState(false);

useEffect(() => {
  runMigrations()
    .then(() => setDbReady(true))
    .catch((err) => console.error('[DB] Migration failed:', err));
}, []);

// Add dbReady to the loading condition:
if (!dbReady || sessionLoading) {
  return (
    <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>
      <ActivityIndicator size="large" />
    </View>
  );
}
```

This ensures the database is ready before any screens that might query it.
  </action>
  <verify>
Run `pnpm --filter @k7notes/mobile start` and launch on iOS simulator.
Check Metro console for "[DB] Migrations complete" message.
Verify app loads past the loading spinner to home screen.
No errors in console related to SQLite or migrations.
  </verify>
  <done>
Database initializes on app startup.
Migrations run before any screens render.
App shows loading state until database is ready.
Console confirms successful migration.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @k7notes/mobile type-check` passes
2. App starts without crash
3. Console shows "[DB] Migrations complete"
4. No SQLite errors in console
5. Database file k7notes.db is created (check via sqlite browser or expo tools)
</verification>

<success_criteria>
- expo-sqlite and drizzle-orm installed and configured
- Metro bundler loads .sql migration files via inline-import
- Drizzle schema defines notes and folders tables
- Database client provides db instance and runMigrations
- App initializes database on startup before rendering screens
- TypeScript compilation passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-note-taking/02-01-SUMMARY.md`
</output>
