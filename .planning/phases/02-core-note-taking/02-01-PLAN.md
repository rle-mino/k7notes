---
phase: 02-core-note-taking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/db/schema.ts
  - apps/mobile/db/client.ts
  - apps/mobile/db/migrations/0000_init.sql
  - apps/mobile/db/migrations/migrations.js
  - apps/mobile/metro.config.js
  - apps/mobile/babel.config.js
  - apps/mobile/package.json
  - apps/mobile/drizzle.config.ts
  - apps/mobile/app/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "SQLite database initializes on app startup"
    - "Migrations run before app renders main content"
    - "Notes and folders tables exist with correct schema"
  artifacts:
    - path: "apps/mobile/db/schema.ts"
      provides: "Drizzle schema with notes and folders tables"
      contains: "sqliteTable"
    - path: "apps/mobile/db/client.ts"
      provides: "Drizzle client with expo-sqlite connection"
      contains: "drizzle"
    - path: "apps/mobile/db/migrations/0000_init.sql"
      provides: "Initial migration SQL"
      contains: "CREATE TABLE"
    - path: "apps/mobile/metro.config.js"
      provides: "Metro config with .sql extension support"
      contains: "sourceExts"
  key_links:
    - from: "apps/mobile/app/_layout.tsx"
      to: "apps/mobile/db/client.ts"
      via: "useMigrations hook"
      pattern: "useMigrations"
    - from: "apps/mobile/db/client.ts"
      to: "expo-sqlite"
      via: "openDatabaseSync"
      pattern: "openDatabaseSync"
---

<objective>
Set up SQLite database with Drizzle ORM for local-first note storage

Purpose: Establish the data layer foundation that all note-taking features depend on. Without a working database with proper migrations, no other Phase 2 work can proceed.

Output: Working SQLite database initialized at app startup, with notes and folders tables ready for CRUD operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-note-taking/02-RESEARCH.md

# Existing files to modify
@apps/mobile/app/_layout.tsx
@apps/mobile/metro.config.js
@apps/mobile/babel.config.js
@apps/mobile/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install database dependencies and configure bundler</name>
  <files>
    apps/mobile/package.json
    apps/mobile/metro.config.js
    apps/mobile/babel.config.js
    apps/mobile/drizzle.config.ts
  </files>
  <action>
Install database packages:
```bash
cd apps/mobile
npx expo install expo-sqlite
pnpm add drizzle-orm
pnpm add -D drizzle-kit babel-plugin-inline-import
```

Update metro.config.js to add 'sql' to sourceExts:
```javascript
const { getDefaultConfig } = require('expo/metro-config');
const config = getDefaultConfig(__dirname);
config.resolver.sourceExts.push('sql');
module.exports = config;
```

Update babel.config.js to add inline-import plugin for .sql files:
```javascript
module.exports = function (api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: [
      ["inline-import", { "extensions": [".sql"] }]
    ],
  };
};
```

Create drizzle.config.ts for migration generation:
```typescript
import type { Config } from 'drizzle-kit';

export default {
  schema: './db/schema.ts',
  out: './db/migrations',
  dialect: 'sqlite',
  driver: 'expo',
} satisfies Config;
```
  </action>
  <verify>
- `pnpm list expo-sqlite drizzle-orm` shows both installed
- `pnpm list -D drizzle-kit babel-plugin-inline-import` shows both installed
- metro.config.js contains `sourceExts.push('sql')`
- babel.config.js contains `inline-import` plugin
- drizzle.config.ts exists and is valid TypeScript
  </verify>
  <done>All database dependencies installed, Metro and Babel configured for .sql imports, Drizzle config ready for migration generation</done>
</task>

<task type="auto">
  <name>Task 2: Create database schema and generate initial migration</name>
  <files>
    apps/mobile/db/schema.ts
    apps/mobile/db/client.ts
    apps/mobile/db/migrations/0000_init.sql
    apps/mobile/db/migrations/migrations.js
  </files>
  <action>
Create apps/mobile/db/schema.ts with notes and folders tables using Drizzle schema DSL:

```typescript
import { sqliteTable, text, integer, index } from "drizzle-orm/sqlite-core";

export const folders = sqliteTable("folders", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  name: text("name").notNull(),
  parentId: integer("parent_id").references(() => folders.id, {
    onDelete: "cascade"
  }),
  createdAt: integer("created_at", { mode: "timestamp" })
    .$defaultFn(() => new Date()),
  updatedAt: integer("updated_at", { mode: "timestamp" })
    .$defaultFn(() => new Date()),
}, (table) => ({
  parentIdx: index("parent_idx").on(table.parentId),
}));

export const notes = sqliteTable("notes", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  title: text("title").notNull(),
  content: text("content").notNull().default(""),
  folderId: integer("folder_id").references(() => folders.id, {
    onDelete: "set null"
  }),
  createdAt: integer("created_at", { mode: "timestamp" })
    .$defaultFn(() => new Date()),
  updatedAt: integer("updated_at", { mode: "timestamp" })
    .$defaultFn(() => new Date()),
}, (table) => ({
  folderIdx: index("folder_idx").on(table.folderId),
}));
```

Create apps/mobile/db/client.ts:
```typescript
import { drizzle } from "drizzle-orm/expo-sqlite";
import { openDatabaseSync } from "expo-sqlite";
import * as schema from "./schema";

const expo = openDatabaseSync("k7notes.db", {
  enableChangeListener: true,
});

export const db = drizzle(expo, { schema });
```

Generate migration using Drizzle Kit:
```bash
cd apps/mobile
pnpm drizzle-kit generate
```

This creates db/migrations/0000_init.sql and db/migrations/meta/_journal.json.

Create db/migrations/migrations.js to export migrations for useMigrations hook:
```javascript
import m0000 from "./0000_init.sql";

export default {
  journal: {
    entries: [
      { idx: 0, when: Date.now(), tag: "0000_init" }
    ]
  },
  migrations: {
    "0000_init": m0000
  }
};
```
  </action>
  <verify>
- apps/mobile/db/schema.ts exists and exports `folders` and `notes` tables
- apps/mobile/db/client.ts exports `db` client
- apps/mobile/db/migrations/0000_init.sql exists with CREATE TABLE statements
- TypeScript compiles without errors: `cd apps/mobile && pnpm exec tsc --noEmit`
  </verify>
  <done>Database schema defined, initial migration generated, client ready for use</done>
</task>

<task type="auto">
  <name>Task 3: Integrate migrations into app startup</name>
  <files>
    apps/mobile/app/_layout.tsx
  </files>
  <action>
Update apps/mobile/app/_layout.tsx to run migrations at startup using useMigrations hook:

1. Import useMigrations from drizzle-orm/expo-sqlite/migrator
2. Import db from @/db/client
3. Import migrations from @/db/migrations/migrations
4. Call useMigrations(db, migrations) early in the component
5. Show loading screen while migrations run (before auth check)
6. Show error screen if migrations fail

The migration check should happen BEFORE the auth check. Structure:
```typescript
import { useMigrations } from "drizzle-orm/expo-sqlite/migrator";
import { db } from "@/db/client";
import migrations from "@/db/migrations/migrations";

export default function RootLayout() {
  const { success: dbReady, error: dbError } = useMigrations(db, migrations);
  const { data: session, isPending } = authClient.useSession();

  // Show loading while database initializes
  if (!dbReady && !dbError) {
    return (
      <View style={styles.loading}>
        <ActivityIndicator size="large" color="#007AFF" />
        <Text style={styles.loadingText}>Loading database...</Text>
      </View>
    );
  }

  // Show error if database failed
  if (dbError) {
    return (
      <View style={styles.error}>
        <Text style={styles.errorTitle}>Database Error</Text>
        <Text style={styles.errorText}>{dbError.message}</Text>
      </View>
    );
  }

  // Then proceed with auth check and navigation...
}
```

Add error styles to the StyleSheet.
  </action>
  <verify>
- App starts without crashing: `cd apps/mobile && npx expo start --clear`
- Database loading screen appears briefly on first launch
- After loading, auth flow works as before (redirects to login or home)
- No TypeScript errors: `cd apps/mobile && pnpm exec tsc --noEmit`
- Check database file exists on device/simulator after first run
  </verify>
  <done>App initializes database on startup, runs migrations, shows appropriate loading/error states</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Database Initialization:**
   - Cold start the app (clear cache: `npx expo start --clear`)
   - "Loading database..." appears briefly
   - App proceeds to auth flow after database ready

2. **Schema Correctness:**
   - Using SQLite browser or Drizzle Studio, verify:
     - `folders` table exists with id, name, parent_id, created_at, updated_at
     - `notes` table exists with id, title, content, folder_id, created_at, updated_at
     - Indexes exist on parent_id and folder_id

3. **No Regressions:**
   - Existing auth flow still works
   - Login/logout still functional
   - No console errors related to database

4. **Build Verification:**
   - `cd apps/mobile && pnpm exec tsc --noEmit` passes
   - Metro bundler starts without .sql import errors
</verification>

<success_criteria>
- expo-sqlite, drizzle-orm installed and working
- Metro bundler handles .sql file imports
- Database schema matches design (notes + folders tables)
- Migrations run on app startup before auth check
- App shows loading state during migration
- All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-note-taking/02-01-SUMMARY.md`
</output>
