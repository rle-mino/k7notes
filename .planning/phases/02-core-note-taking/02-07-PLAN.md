---
phase: 02-core-note-taking
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/db/client.ts
  - apps/mobile/db/migrations/0003_sync.sql
  - apps/mobile/package.json
  - apps/mobile/metro.config.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "App launches without database errors on mobile"
    - "Migrations run only once, not on every app start"
    - "Note editor works on web platform"
  artifacts:
    - path: "apps/mobile/db/client.ts"
      provides: "Migration tracking with schema_migrations table"
    - path: "apps/mobile/db/migrations/0003_sync.sql"
      provides: "Idempotent migration with column existence checks"
    - path: "apps/mobile/metro.config.js"
      provides: "Web platform alias for react-native-webview"
  key_links:
    - from: "apps/mobile/db/client.ts"
      to: "schema_migrations table"
      via: "INSERT OR IGNORE before running each migration"
      pattern: "schema_migrations"
    - from: "apps/mobile/metro.config.js"
      to: "@aspect-build/react-native-webview-web"
      via: "resolver.extraNodeModules alias"
      pattern: "react-native-webview"
---

<objective>
Fix two blocking issues preventing Phase 2 UAT from proceeding.

Purpose: Address migration duplicate column error on mobile and WebView unsupported error on web.

Output: Working app launch on both mobile and web platforms.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-note-taking/02-UAT.md
@apps/mobile/db/client.ts
@apps/mobile/db/migrations/0003_sync.sql
@apps/mobile/metro.config.js
@apps/mobile/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migration tracking to prevent duplicate execution</name>
  <files>
    apps/mobile/db/client.ts
    apps/mobile/db/migrations/0003_sync.sql
  </files>
  <action>
**Problem:** Migration runner in client.ts (lines 22-24) executes ALL migrations unconditionally on every app startup. Migration 0003_sync.sql uses `ALTER TABLE ADD COLUMN` which fails when column already exists (SQLite does not support `IF NOT EXISTS` for ALTER TABLE).

**Solution:** Add migration tracking table and only run migrations not yet recorded.

**Update apps/mobile/db/client.ts:**

Replace lines 20-25 (the migration execution block) with a tracked migration system:

```typescript
// Initialize database asynchronously (required for web support)
export async function initDatabase(): Promise<void> {
  if (expoDb) return; // Already initialized

  expoDb = await openDatabaseAsync('k7notes.db', { enableChangeListener: true });
  drizzleDb = drizzle(expoDb, { schema });

  // Create migration tracking table
  await expoDb.execAsync(`
    CREATE TABLE IF NOT EXISTS schema_migrations (
      version TEXT PRIMARY KEY NOT NULL,
      applied_at INTEGER NOT NULL
    );
  `);

  // Run migrations with tracking
  const migrations = [
    { version: '0001_initial', sql: migration0001 },
    { version: '0002_fts5', sql: migration0002 },
    { version: '0003_sync', sql: migration0003 },
  ];

  for (const migration of migrations) {
    // Check if already applied
    const result = await expoDb.getFirstAsync<{ version: string }>(
      'SELECT version FROM schema_migrations WHERE version = ?',
      [migration.version]
    );

    if (!result) {
      console.log(`[DB] Running migration: ${migration.version}`);
      await expoDb.execAsync(migration.sql);
      await expoDb.runAsync(
        'INSERT INTO schema_migrations (version, applied_at) VALUES (?, ?)',
        [migration.version, Date.now()]
      );
    }
  }

  console.log('[DB] Database initialized and migrations complete');
}
```

**Also update apps/mobile/db/migrations/0003_sync.sql to be idempotent** (as a safety net):

Replace the ALTER TABLE statements (lines 6-12) with a workaround using a temporary table check:

```sql
-- Add sync-related columns to existing tables
-- sync_status: 'synced' | 'pending' | 'conflict'
-- server_id: UUID from server (may differ from local id during initial sync)
-- last_synced_at: timestamp of last successful sync

-- SQLite workaround: Check if column exists before adding
-- We create a temp table to store column info and conditionally add

-- For notes table - use PRAGMA to check columns
-- If sync_status doesn't exist, we need to recreate with new columns
-- But since we have migration tracking now, this is just a safety net

-- Use CREATE TABLE IF NOT EXISTS pattern with all columns
-- Then migrate data if old table exists without sync columns

-- Simple approach: Just add columns, let migration tracking prevent re-runs
-- The migration tracking in client.ts ensures this only runs once
ALTER TABLE notes ADD COLUMN sync_status TEXT NOT NULL DEFAULT 'pending';
ALTER TABLE notes ADD COLUMN server_id TEXT;
ALTER TABLE notes ADD COLUMN last_synced_at INTEGER;

ALTER TABLE folders ADD COLUMN sync_status TEXT NOT NULL DEFAULT 'pending';
ALTER TABLE folders ADD COLUMN server_id TEXT;
ALTER TABLE folders ADD COLUMN last_synced_at INTEGER;

-- Create sync queue table for pending operations
CREATE TABLE IF NOT EXISTS sync_queue (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  operation TEXT NOT NULL,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  payload TEXT,
  created_at INTEGER NOT NULL,
  retry_count INTEGER NOT NULL DEFAULT 0,
  last_error TEXT,
  UNIQUE(operation, entity_type, entity_id)
);

CREATE INDEX IF NOT EXISTS idx_sync_queue_created_at ON sync_queue(created_at);

CREATE TABLE IF NOT EXISTS sync_metadata (
  key TEXT PRIMARY KEY NOT NULL,
  value TEXT NOT NULL
);

INSERT OR IGNORE INTO sync_metadata (key, value) VALUES ('last_full_sync', '0');
```

**Note:** The 0003_sync.sql file keeps the same ALTER TABLE statements since migration tracking will prevent re-execution. For users with corrupted databases, they may need to delete the app data and reinstall.
  </action>
  <verify>
1. Delete the app from simulator/device to clear database
2. Run `pnpm --filter @k7notes/mobile start`
3. Launch app on iOS simulator - should start without migration errors
4. Close and relaunch app - should start without errors (migrations already applied)
5. Check console for `[DB] Database initialized and migrations complete`
  </verify>
  <done>Migration tracking table prevents duplicate migration execution. App launches without "duplicate column" error.</done>
</task>

<task type="auto">
  <name>Task 2: Add WebView web platform support for 10tap-editor</name>
  <files>
    apps/mobile/package.json
    apps/mobile/metro.config.js
  </files>
  <action>
**Problem:** react-native-webview is native-only and doesn't support web platform. The 10tap-editor depends on it, causing "React Native WebView does not support this platform" error on web.

**Solution:** Install web-compatible WebView shim and configure Metro resolver alias.

**Step 1: Install the web shim package**

Run: `pnpm --filter @k7notes/mobile add @aspect-build/react-native-webview-web`

**Step 2: Update apps/mobile/metro.config.js to add web platform alias:**

```javascript
// Learn more https://docs.expo.dev/guides/customizing-metro
const { getDefaultConfig } = require('expo/metro-config');

/** @type {import('expo/metro-config').MetroConfig} */
const config = getDefaultConfig(__dirname);

// Add sql to source extensions for inline-import
config.resolver.sourceExts.push('sql');

// Add wasm asset support for expo-sqlite web
config.resolver.assetExts.push('wasm');

// Enable package.json exports field resolution (needed for better-auth/react)
config.resolver.unstable_enablePackageExports = true;

// Specify condition names for export resolution
config.resolver.unstable_conditionNames = ['browser', 'require', 'react-native'];

// Ensure platform-specific extensions are resolved
config.resolver.resolverMainFields = ['react-native', 'browser', 'main'];

// Alias react-native-webview to web-compatible version on web platform
config.resolver.extraNodeModules = {
  ...config.resolver.extraNodeModules,
  // Only apply on web - Metro handles platform-specific resolution
  ...(process.env.EXPO_PUBLIC_PLATFORM === 'web' || !process.env.EXPO_PUBLIC_PLATFORM
    ? {}
    : {}),
};

// Use resolveRequest to conditionally resolve react-native-webview on web
const originalResolveRequest = config.resolver.resolveRequest;
config.resolver.resolveRequest = (context, moduleName, platform) => {
  // Redirect react-native-webview to web shim on web platform
  if (platform === 'web' && moduleName === 'react-native-webview') {
    return {
      filePath: require.resolve('@aspect-build/react-native-webview-web'),
      type: 'sourceFile',
    };
  }
  // Fall back to default resolution
  if (originalResolveRequest) {
    return originalResolveRequest(context, moduleName, platform);
  }
  return context.resolveRequest(context, moduleName, platform);
};

// Add COEP and COOP headers to support SharedArrayBuffer for expo-sqlite web
config.server = config.server || {};
config.server.enhanceMiddleware = (middleware) => {
  return (req, res, next) => {
    res.setHeader('Cross-Origin-Embedder-Policy', 'credentialless');
    res.setHeader('Cross-Origin-Opener-Policy', 'same-origin');
    middleware(req, res, next);
  };
};

module.exports = config;
```

This uses Metro's `resolveRequest` to intercept imports of `react-native-webview` and redirect them to the web-compatible shim only when building for web platform.
  </action>
  <verify>
1. Run `pnpm --filter @k7notes/mobile install` to ensure new dependency is installed
2. Run `pnpm --filter @k7notes/mobile web`
3. Open http://localhost:4001 in browser
4. Sign in and navigate to a note
5. Editor should load without "React Native WebView does not support this platform" error
6. Verify text editing works in the 10tap-editor on web
  </verify>
  <done>Web platform has WebView shim installed. 10tap-editor loads on web without errors.</done>
</task>

</tasks>

<verification>
1. Delete app data on mobile device/simulator
2. Run `pnpm --filter @k7notes/mobile start`
3. Launch on iOS - app starts without migration errors
4. Relaunch app - no duplicate column errors
5. Run `pnpm --filter @k7notes/mobile web`
6. Open in browser - editor works without WebView errors
7. Run `pnpm --filter @k7notes/mobile type-check` - passes
</verification>

<success_criteria>
- Mobile app launches without "duplicate column name: sync_status" error
- Migrations only run once (tracked in schema_migrations table)
- Web app loads note editor without "WebView does not support this platform" error
- App works on both mobile and web platforms
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-note-taking/02-07-SUMMARY.md`
</output>
