---
phase: 02-core-note-taking
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/mobile/db/migrations/0001_add_fts.sql
  - apps/mobile/db/migrations/migrations.js
  - apps/mobile/db/queries/search.ts
  - apps/mobile/db/queries/index.ts
autonomous: true

must_haves:
  truths:
    - "Full-text search finds notes by content"
    - "Search returns ranked results with snippets"
    - "FTS index stays in sync with notes table"
  artifacts:
    - path: "apps/mobile/db/migrations/0001_add_fts.sql"
      provides: "FTS5 virtual table and sync triggers"
      contains: "CREATE VIRTUAL TABLE"
    - path: "apps/mobile/db/queries/search.ts"
      provides: "Search query functions"
      exports: ["searchNotes", "SearchResult"]
  key_links:
    - from: "apps/mobile/db/migrations/0001_add_fts.sql"
      to: "notes table"
      via: "FTS5 external content"
      pattern: "content=notes"
    - from: "apps/mobile/db/queries/search.ts"
      to: "notes_fts virtual table"
      via: "FTS5 MATCH query"
      pattern: "notes_fts MATCH"
---

<objective>
Set up SQLite FTS5 full-text search with automatic index synchronization

Purpose: Enable instant search across all note content. FTS5 provides tokenization, stemming, phrase search, and BM25 ranking - far superior to LIKE queries.

Output: FTS5 virtual table with triggers to keep it synchronized, plus search query functions that return ranked results with highlighted snippets.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-note-taking/02-RESEARCH.md

# Files from Plan 01
@apps/mobile/db/schema.ts
@apps/mobile/db/client.ts
@apps/mobile/db/migrations/migrations.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FTS5 migration with sync triggers</name>
  <files>
    apps/mobile/db/migrations/0001_add_fts.sql
    apps/mobile/db/migrations/migrations.js
  </files>
  <action>
Create apps/mobile/db/migrations/0001_add_fts.sql:

```sql
-- Create FTS5 virtual table for full-text search on notes
-- Uses external content mode to avoid duplicating data
CREATE VIRTUAL TABLE notes_fts USING fts5(
  title,
  content,
  content=notes,
  content_rowid=id,
  tokenize='porter unicode61'
);

-- Trigger to insert into FTS when note is created
CREATE TRIGGER notes_fts_insert AFTER INSERT ON notes BEGIN
  INSERT INTO notes_fts(rowid, title, content)
  VALUES (new.id, new.title, new.content);
END;

-- Trigger to update FTS when note is deleted
-- Note: FTS5 uses 'delete' command in special way
CREATE TRIGGER notes_fts_delete AFTER DELETE ON notes BEGIN
  INSERT INTO notes_fts(notes_fts, rowid, title, content)
  VALUES('delete', old.id, old.title, old.content);
END;

-- Trigger to update FTS when note is updated
-- Must delete old values first, then insert new
CREATE TRIGGER notes_fts_update AFTER UPDATE ON notes BEGIN
  INSERT INTO notes_fts(notes_fts, rowid, title, content)
  VALUES('delete', old.id, old.title, old.content);
  INSERT INTO notes_fts(rowid, title, content)
  VALUES (new.id, new.title, new.content);
END;

-- Populate FTS with existing notes (for fresh installs this will be empty)
INSERT INTO notes_fts(rowid, title, content)
SELECT id, title, content FROM notes;
```

Update apps/mobile/db/migrations/migrations.js to include the new migration:

```javascript
import m0000 from "./0000_init.sql";
import m0001 from "./0001_add_fts.sql";

export default {
  journal: {
    entries: [
      { idx: 0, when: Date.now(), tag: "0000_init" },
      { idx: 1, when: Date.now(), tag: "0001_add_fts" }
    ]
  },
  migrations: {
    "0000_init": m0000,
    "0001_add_fts": m0001
  }
};
```
  </action>
  <verify>
- apps/mobile/db/migrations/0001_add_fts.sql exists
- File contains CREATE VIRTUAL TABLE with fts5
- File contains all three triggers (INSERT, DELETE, UPDATE)
- migrations.js includes both migrations
- TypeScript compiles: `cd apps/mobile && pnpm exec tsc --noEmit`
  </verify>
  <done>FTS5 virtual table and sync triggers ready for deployment</done>
</task>

<task type="auto">
  <name>Task 2: Create search query functions</name>
  <files>
    apps/mobile/db/queries/search.ts
  </files>
  <action>
Create apps/mobile/db/queries/search.ts with FTS5 search queries:

```typescript
import { sql } from "drizzle-orm";
import { db } from "../client";
import { type Note } from "./notes";

export interface SearchResult {
  id: number;
  title: string;
  content: string;
  folderId: number | null;
  titleSnippet: string;
  contentSnippet: string;
  rank: number;
  createdAt: Date;
  updatedAt: Date;
}

// Search notes using FTS5 with BM25 ranking
export async function searchNotes(query: string): Promise<SearchResult[]> {
  if (!query.trim()) return [];

  // Escape special FTS5 characters and prepare query
  // FTS5 treats these as operators: AND OR NOT ( ) " * ^
  const safeQuery = query
    .replace(/['"]/g, '""')  // Escape quotes
    .trim();

  if (!safeQuery) return [];

  const results = await db.all<SearchResult>(sql`
    SELECT
      n.id,
      n.title,
      n.content,
      n.folder_id as folderId,
      n.created_at as createdAt,
      n.updated_at as updatedAt,
      snippet(notes_fts, 0, '<mark>', '</mark>', '...', 32) as titleSnippet,
      snippet(notes_fts, 1, '<mark>', '</mark>', '...', 64) as contentSnippet,
      bm25(notes_fts, 10.0, 1.0) as rank
    FROM notes_fts
    JOIN notes n ON notes_fts.rowid = n.id
    WHERE notes_fts MATCH ${safeQuery}
    ORDER BY rank
    LIMIT 50;
  `);

  return results;
}

// Search with phrase matching (for "exact phrase" searches)
export async function searchNotesPhrase(phrase: string): Promise<SearchResult[]> {
  if (!phrase.trim()) return [];

  // Wrap in quotes for phrase matching
  const phraseQuery = `"${phrase.replace(/"/g, '""')}"`;

  return searchNotes(phraseQuery);
}

// Get recent notes (useful for showing when search is empty)
export async function getRecentNotes(limit: number = 10): Promise<SearchResult[]> {
  const results = await db.all<SearchResult>(sql`
    SELECT
      id,
      title,
      content,
      folder_id as folderId,
      created_at as createdAt,
      updated_at as updatedAt,
      title as titleSnippet,
      substr(content, 1, 100) || CASE WHEN length(content) > 100 THEN '...' ELSE '' END as contentSnippet,
      0 as rank
    FROM notes
    ORDER BY updated_at DESC
    LIMIT ${limit};
  `);

  return results;
}
```
  </action>
  <verify>
- apps/mobile/db/queries/search.ts exists
- Exports searchNotes, searchNotesPhrase, getRecentNotes, SearchResult type
- TypeScript compiles: `cd apps/mobile && pnpm exec tsc --noEmit`
  </verify>
  <done>Search query functions ready with FTS5 MATCH and BM25 ranking</done>
</task>

<task type="auto">
  <name>Task 3: Export search functions and verify FTS works</name>
  <files>
    apps/mobile/db/queries/index.ts
  </files>
  <action>
Update apps/mobile/db/queries/index.ts to include search exports:

```typescript
// Note operations
export {
  createNote,
  getNote,
  getNotes,
  getAllNotes,
  updateNote,
  deleteNote,
  moveNote,
  type Note,
  type NewNote,
} from "./notes";

// Folder operations
export {
  createFolder,
  getFolder,
  getFolders,
  getFolderTree,
  getFolderPath,
  updateFolder,
  deleteFolder,
  canMoveFolder,
  moveFolder,
  type Folder,
  type NewFolder,
  type FolderWithMeta,
} from "./folders";

// Search operations
export {
  searchNotes,
  searchNotesPhrase,
  getRecentNotes,
  type SearchResult,
} from "./search";
```

Verify FTS works by:
1. Start app fresh to run new migration
2. Create a test note via temporary code or React Native debugger console
3. Search for words in that note
4. Verify results include the note with snippets

Quick verification script (can add to home.tsx temporarily):
```typescript
import { createNote, searchNotes } from "@/db/queries";

// In component or useEffect:
async function testSearch() {
  await createNote({ title: "Meeting Notes", content: "We discussed the project timeline and budget" });
  const results = await searchNotes("timeline");
  console.log("Search results:", results);
}
```
  </action>
  <verify>
- apps/mobile/db/queries/index.ts exports all search functions
- App starts and runs both migrations successfully
- Creating a note and searching for its content returns results
- TypeScript compiles: `cd apps/mobile && pnpm exec tsc --noEmit`
- `@/db/queries` import includes searchNotes
  </verify>
  <done>FTS5 search fully integrated and verified working</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Migration Runs:**
   - Clear app cache and restart: `npx expo start --clear`
   - App shows loading, then proceeds to auth flow
   - No migration errors in console

2. **FTS5 Table Exists:**
   - Using SQLite browser or running raw query, verify:
     - notes_fts virtual table exists
     - All three triggers exist (notes_fts_insert, notes_fts_delete, notes_fts_update)

3. **Search Works:**
   - Create a note with specific content
   - Search for words from that content
   - Results include the note with correct snippets
   - Empty query returns empty results (no crash)

4. **Trigger Sync:**
   - Create note -> appears in search immediately
   - Update note content -> search reflects changes
   - Delete note -> no longer appears in search

5. **Build Check:**
   - `cd apps/mobile && pnpm exec tsc --noEmit` passes
   - No runtime errors
</verification>

<success_criteria>
- FTS5 virtual table created with porter tokenizer
- All three sync triggers in place (INSERT, UPDATE, DELETE)
- searchNotes returns ranked results with snippets
- FTS index stays synchronized with notes table
- Search query escapes special characters safely
- TypeScript types correct for SearchResult
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-note-taking/02-03-SUMMARY.md`
</output>
