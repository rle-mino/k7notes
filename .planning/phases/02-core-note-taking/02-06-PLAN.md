---
phase: 02-core-note-taking
plan: 06
type: execute
wave: 4
depends_on: ["02-03", "02-04", "02-05"]
files_modified:
  - apps/mobile/app/(app)/search/index.tsx
  - apps/mobile/app/(app)/notes/[id].tsx
  - apps/mobile/app/(app)/home.tsx
  - apps/mobile/src/components/notes/MoveNoteModal.tsx
  - apps/mobile/src/components/notes/index.ts
autonomous: false

must_haves:
  truths:
    - "User can search notes and see results instantly"
    - "Search results show snippet with highlighted matches"
    - "User can move a note to a different folder"
    - "User can navigate to notes from home screen"
    - "Complete note workflow functions end-to-end"
  artifacts:
    - path: "apps/mobile/app/(app)/search/index.tsx"
      provides: "Search screen with results"
    - path: "apps/mobile/src/components/notes/MoveNoteModal.tsx"
      provides: "Folder picker modal for moving notes"
  key_links:
    - from: "apps/mobile/app/(app)/search/index.tsx"
      to: "db/queries/search"
      via: "searchNotes function"
      pattern: "searchNotes"
    - from: "apps/mobile/src/components/notes/MoveNoteModal.tsx"
      to: "db/queries/notes"
      via: "moveNote function"
      pattern: "moveNote"
---

<objective>
Complete Phase 2 with search functionality, move note capability, and final integration.

Purpose: Deliver the remaining features (NOTE-04 search, NOTE-03 move) and verify the complete note-taking workflow.

Output: Working search screen, move note modal, home screen navigation, and verified end-to-end functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-note-taking/02-03-SUMMARY.md
@.planning/phases/02-core-note-taking/02-04-SUMMARY.md
@.planning/phases/02-core-note-taking/02-05-SUMMARY.md
@apps/mobile/db/queries/search.ts
@apps/mobile/app/(app)/notes/[id].tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search screen with FTS5 integration</name>
  <files>
    apps/mobile/app/(app)/search/index.tsx
  </files>
  <action>
Create apps/mobile/app/(app)/search/index.tsx:

```typescript
import React, { useState, useCallback, useEffect } from 'react';
import {
  StyleSheet,
  View,
  TextInput,
  FlatList,
  Text,
  TouchableOpacity,
  ActivityIndicator,
} from 'react-native';
import { router } from 'expo-router';
import { searchNotes, SearchResult } from '@/db';

export default function SearchScreen() {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState<SearchResult[]>([]);
  const [loading, setLoading] = useState(false);
  const [searched, setSearched] = useState(false);

  // Debounced search
  useEffect(() => {
    if (!query.trim()) {
      setResults([]);
      setSearched(false);
      return;
    }

    const timer = setTimeout(async () => {
      setLoading(true);
      try {
        const searchResults = await searchNotes(query);
        setResults(searchResults);
        setSearched(true);
      } catch (err) {
        console.error('Search failed:', err);
        setResults([]);
      } finally {
        setLoading(false);
      }
    }, 300); // 300ms debounce

    return () => clearTimeout(timer);
  }, [query]);

  const handleNotePress = (noteId: string) => {
    router.push(`/notes/${noteId}`);
  };

  const renderResult = ({ item }: { item: SearchResult }) => (
    <TouchableOpacity
      style={styles.resultCard}
      onPress={() => handleNotePress(item.note.id)}
      activeOpacity={0.7}
    >
      <Text style={styles.resultTitle} numberOfLines={1}>
        {item.note.title || 'Untitled'}
      </Text>
      {/* Render snippet with basic HTML parsing for <mark> tags */}
      <Text style={styles.resultSnippet} numberOfLines={3}>
        {item.snippet
          .replace(/<mark>/g, '')
          .replace(/<\/mark>/g, '')
          .replace(/\.\.\./g, '...')}
      </Text>
      <Text style={styles.resultDate}>
        {new Date(item.note.updatedAt).toLocaleDateString(undefined, {
          month: 'short',
          day: 'numeric',
        })}
      </Text>
    </TouchableOpacity>
  );

  return (
    <View style={styles.container}>
      <View style={styles.searchContainer}>
        <TextInput
          style={styles.searchInput}
          value={query}
          onChangeText={setQuery}
          placeholder="Search notes..."
          placeholderTextColor="#999"
          autoFocus
          autoCapitalize="none"
          autoCorrect={false}
          clearButtonMode="while-editing"
        />
      </View>

      {loading && (
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="small" />
        </View>
      )}

      {!loading && searched && results.length === 0 && (
        <View style={styles.emptyContainer}>
          <Text style={styles.emptyText}>No results found</Text>
          <Text style={styles.emptyHint}>Try different keywords</Text>
        </View>
      )}

      {!loading && results.length > 0 && (
        <FlatList
          data={results}
          keyExtractor={(item) => item.note.id}
          renderItem={renderResult}
          contentContainerStyle={styles.resultsList}
        />
      )}

      {!searched && !loading && (
        <View style={styles.emptyContainer}>
          <Text style={styles.emptyEmoji}>üîç</Text>
          <Text style={styles.emptyText}>Search your notes</Text>
          <Text style={styles.emptyHint}>
            Find notes by title or content
          </Text>
        </View>
      )}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  searchContainer: {
    backgroundColor: '#fff',
    padding: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  searchInput: {
    backgroundColor: '#f0f0f0',
    borderRadius: 10,
    paddingHorizontal: 16,
    paddingVertical: 12,
    fontSize: 16,
    color: '#1a1a1a',
  },
  loadingContainer: {
    padding: 20,
    alignItems: 'center',
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 32,
  },
  emptyEmoji: {
    fontSize: 48,
    marginBottom: 16,
  },
  emptyText: {
    fontSize: 18,
    fontWeight: '600',
    color: '#666',
    marginBottom: 8,
  },
  emptyHint: {
    fontSize: 14,
    color: '#999',
    textAlign: 'center',
  },
  resultsList: {
    paddingVertical: 8,
  },
  resultCard: {
    backgroundColor: '#fff',
    borderRadius: 12,
    padding: 16,
    marginHorizontal: 16,
    marginVertical: 6,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.05,
    shadowRadius: 2,
    elevation: 1,
  },
  resultTitle: {
    fontSize: 17,
    fontWeight: '600',
    color: '#1a1a1a',
    marginBottom: 4,
  },
  resultSnippet: {
    fontSize: 14,
    color: '#666',
    lineHeight: 20,
    marginBottom: 8,
  },
  resultDate: {
    fontSize: 12,
    color: '#999',
  },
});
```
  </action>
  <verify>
Run `pnpm --filter @k7notes/mobile type-check` passes.
  </verify>
  <done>Search screen created with debounced FTS5 search and result display</done>
</task>

<task type="auto">
  <name>Task 2: Create move note modal and integrate with editor</name>
  <files>
    apps/mobile/src/components/notes/MoveNoteModal.tsx
    apps/mobile/src/components/notes/index.ts
    apps/mobile/app/(app)/notes/[id].tsx
  </files>
  <action>
Create apps/mobile/src/components/notes/MoveNoteModal.tsx:

```typescript
import React, { useState } from 'react';
import {
  StyleSheet,
  View,
  Modal,
  Text,
  TouchableOpacity,
  FlatList,
  ActivityIndicator,
} from 'react-native';
import { useLiveQuery, listAllFolders, moveNote, Folder } from '@/db';

interface MoveNoteModalProps {
  visible: boolean;
  noteId: string;
  currentFolderId: string | null;
  onClose: () => void;
  onMoved: () => void;
}

export function MoveNoteModal({
  visible,
  noteId,
  currentFolderId,
  onClose,
  onMoved,
}: MoveNoteModalProps) {
  const { data: folders, loading } = useLiveQuery(() => listAllFolders(), []);
  const [moving, setMoving] = useState(false);

  const handleMove = async (folderId: string | null) => {
    if (folderId === currentFolderId) {
      onClose();
      return;
    }

    setMoving(true);
    try {
      await moveNote(noteId, folderId);
      onMoved();
      onClose();
    } catch (err) {
      console.error('Failed to move note:', err);
    } finally {
      setMoving(false);
    }
  };

  const renderFolder = ({ item }: { item: Folder | { id: null; name: string } }) => {
    const isCurrentFolder = item.id === currentFolderId;
    return (
      <TouchableOpacity
        style={[styles.folderItem, isCurrentFolder && styles.folderItemCurrent]}
        onPress={() => handleMove(item.id)}
        disabled={moving}
      >
        <Text style={styles.folderIcon}>{item.id === null ? 'üè†' : 'üìÅ'}</Text>
        <Text style={[styles.folderName, isCurrentFolder && styles.folderNameCurrent]}>
          {item.name}
        </Text>
        {isCurrentFolder && <Text style={styles.currentBadge}>Current</Text>}
      </TouchableOpacity>
    );
  };

  // Add "Root" option at the beginning
  const allOptions = [
    { id: null as string | null, name: 'Notes (Root)' },
    ...(folders ?? []),
  ];

  return (
    <Modal visible={visible} transparent animationType="slide" onRequestClose={onClose}>
      <View style={styles.overlay}>
        <View style={styles.container}>
          <View style={styles.header}>
            <Text style={styles.title}>Move to folder</Text>
            <TouchableOpacity onPress={onClose} style={styles.closeButton}>
              <Text style={styles.closeButtonText}>Cancel</Text>
            </TouchableOpacity>
          </View>

          {loading ? (
            <View style={styles.loading}>
              <ActivityIndicator />
            </View>
          ) : (
            <FlatList
              data={allOptions}
              keyExtractor={(item) => item.id ?? 'root'}
              renderItem={renderFolder}
              contentContainerStyle={styles.list}
            />
          )}

          {moving && (
            <View style={styles.movingOverlay}>
              <ActivityIndicator color="#fff" />
              <Text style={styles.movingText}>Moving...</Text>
            </View>
          )}
        </View>
      </View>
    </Modal>
  );
}

const styles = StyleSheet.create({
  overlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.4)',
    justifyContent: 'flex-end',
  },
  container: {
    backgroundColor: '#fff',
    borderTopLeftRadius: 20,
    borderTopRightRadius: 20,
    maxHeight: '70%',
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  title: {
    fontSize: 18,
    fontWeight: '600',
  },
  closeButton: {
    padding: 4,
  },
  closeButtonText: {
    fontSize: 16,
    color: '#007AFF',
  },
  loading: {
    padding: 40,
    alignItems: 'center',
  },
  list: {
    paddingVertical: 8,
  },
  folderItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 14,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
  },
  folderItemCurrent: {
    backgroundColor: '#f8f8f8',
  },
  folderIcon: {
    fontSize: 24,
    marginRight: 12,
  },
  folderName: {
    fontSize: 16,
    flex: 1,
  },
  folderNameCurrent: {
    color: '#666',
  },
  currentBadge: {
    fontSize: 12,
    color: '#999',
    backgroundColor: '#eee',
    paddingHorizontal: 8,
    paddingVertical: 2,
    borderRadius: 10,
  },
  movingOverlay: {
    ...StyleSheet.absoluteFillObject,
    backgroundColor: 'rgba(0,0,0,0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    borderTopLeftRadius: 20,
    borderTopRightRadius: 20,
  },
  movingText: {
    color: '#fff',
    marginTop: 8,
    fontSize: 16,
  },
});
```

Update apps/mobile/src/components/notes/index.ts:
```typescript
export { NoteCard } from './NoteCard';
export { FolderCard } from './FolderCard';
export { EmptyState } from './EmptyState';
export { MoveNoteModal } from './MoveNoteModal';
```

Update apps/mobile/app/(app)/notes/[id].tsx to add move functionality:

Add import at top:
```typescript
import { MoveNoteModal } from '@/components/notes';
```

Add state for move modal (inside component):
```typescript
const [showMoveModal, setShowMoveModal] = useState(false);
```

Add Move button to headerRight (alongside Save and Delete):
```typescript
<TouchableOpacity style={styles.moveButton} onPress={() => setShowMoveModal(true)}>
  <Text style={styles.moveButtonText}>Move</Text>
</TouchableOpacity>
```

Add MoveNoteModal at end of component (before closing fragment):
```typescript
<MoveNoteModal
  visible={showMoveModal}
  noteId={id}
  currentFolderId={note?.folderId ?? null}
  onClose={() => setShowMoveModal(false)}
  onMoved={() => {
    setHasChanges(false); // Reset changes since we're navigating away
  }}
/>
```

Add styles for move button:
```typescript
moveButton: {
  paddingHorizontal: 12,
  paddingVertical: 6,
},
moveButtonText: {
  color: '#007AFF',
  fontSize: 16,
},
```
  </action>
  <verify>
Run `pnpm --filter @k7notes/mobile type-check` passes.
  </verify>
  <done>MoveNoteModal created and integrated with note editor screen</done>
</task>

<task type="auto">
  <name>Task 3: Update home screen with navigation to notes</name>
  <files>
    apps/mobile/app/(app)/home.tsx
  </files>
  <action>
Update apps/mobile/app/(app)/home.tsx to add navigation buttons:

Replace the placeholder content section with navigation buttons:

```typescript
import { useState } from "react";
import {
  StyleSheet,
  Text,
  View,
  TouchableOpacity,
  Alert,
  ActivityIndicator,
} from "react-native";
import { router } from "expo-router";
import { authClient } from "@/lib/auth";

export default function HomeScreen() {
  const { data: session } = authClient.useSession();
  const [loggingOut, setLoggingOut] = useState(false);

  const handleLogout = async () => {
    setLoggingOut(true);
    try {
      await authClient.signOut();
    } catch (err) {
      Alert.alert("Error", "Could not sign out. Please try again.");
      setLoggingOut(false);
    }
  };

  const confirmLogout = () => {
    Alert.alert("Sign Out", "Are you sure you want to sign out?", [
      { text: "Cancel", style: "cancel" },
      { text: "Sign Out", style: "destructive", onPress: handleLogout },
    ]);
  };

  return (
    <View style={styles.container}>
      <View style={styles.content}>
        <Text style={styles.title}>K7Notes</Text>

        {session?.user && (
          <View style={styles.userInfo}>
            <Text style={styles.userName}>{session.user.name}</Text>
            <Text style={styles.userEmail}>{session.user.email}</Text>
          </View>
        )}

        <View style={styles.navGrid}>
          <TouchableOpacity
            style={styles.navCard}
            onPress={() => router.push("/notes")}
            activeOpacity={0.7}
          >
            <Text style={styles.navIcon}>üìù</Text>
            <Text style={styles.navTitle}>Notes</Text>
            <Text style={styles.navSubtitle}>View and create notes</Text>
          </TouchableOpacity>

          <TouchableOpacity
            style={styles.navCard}
            onPress={() => router.push("/search")}
            activeOpacity={0.7}
          >
            <Text style={styles.navIcon}>üîç</Text>
            <Text style={styles.navTitle}>Search</Text>
            <Text style={styles.navSubtitle}>Find notes quickly</Text>
          </TouchableOpacity>
        </View>
      </View>

      <View style={styles.footer}>
        <TouchableOpacity
          style={[styles.logoutButton, loggingOut && styles.buttonDisabled]}
          onPress={confirmLogout}
          disabled={loggingOut}
        >
          {loggingOut ? (
            <ActivityIndicator color="#FF3B30" />
          ) : (
            <Text style={styles.logoutButtonText}>Sign Out</Text>
          )}
        </TouchableOpacity>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: "#fff",
  },
  content: {
    flex: 1,
    padding: 24,
  },
  title: {
    fontSize: 32,
    fontWeight: "bold",
    color: "#1a1a1a",
    marginBottom: 4,
  },
  userInfo: {
    marginBottom: 24,
  },
  userName: {
    fontSize: 18,
    fontWeight: "600",
    color: "#333",
  },
  userEmail: {
    fontSize: 14,
    color: "#666",
    marginTop: 2,
  },
  navGrid: {
    gap: 16,
  },
  navCard: {
    backgroundColor: "#f8f8f8",
    borderRadius: 16,
    padding: 20,
    borderWidth: 1,
    borderColor: "#eee",
  },
  navIcon: {
    fontSize: 32,
    marginBottom: 8,
  },
  navTitle: {
    fontSize: 20,
    fontWeight: "600",
    color: "#1a1a1a",
    marginBottom: 4,
  },
  navSubtitle: {
    fontSize: 14,
    color: "#666",
  },
  footer: {
    padding: 24,
    borderTopWidth: 1,
    borderTopColor: "#eee",
  },
  logoutButton: {
    backgroundColor: "#FEE2E2",
    paddingVertical: 14,
    borderRadius: 12,
    alignItems: "center",
  },
  buttonDisabled: {
    opacity: 0.6,
  },
  logoutButtonText: {
    color: "#FF3B30",
    fontSize: 16,
    fontWeight: "600",
  },
});
```
  </action>
  <verify>
Run `pnpm --filter @k7notes/mobile type-check` passes.
  </verify>
  <done>Home screen updated with navigation cards for Notes and Search</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 2 note-taking functionality:
- SQLite database with notes and folders tables
- FTS5 full-text search with auto-sync triggers
- 10tap-editor WYSIWYG editing with markdown storage
- Note list with folder navigation
- Search screen with instant results
- Move note capability
- Home screen with navigation
  </what-built>
  <how-to-verify>
1. Start the app: `pnpm --filter @k7notes/mobile start`
2. Open on iOS simulator or device

**Test note creation:**
3. From Home, tap "Notes" card
4. Tap the pencil FAB to create a new note
5. Enter a title: "My First Note"
6. In the editor, type some text with formatting (try bold, headers, lists)
7. Tap "Save" in header
8. Press back - note should appear in list

**Test folder organization:**
9. Tap the folder FAB (green) to create a folder
10. Name it "Work"
11. Tap into the Work folder
12. Create a note inside it
13. Verify breadcrumb shows path

**Test move note:**
14. Open a note
15. Tap "Move" in header
16. Select a different folder
17. Verify note moves

**Test search:**
18. Go to Search from home
19. Type part of a note title or content
20. Results should appear within 300ms
21. Tap a result to open the note

**Test markdown rendering:**
22. Create a note with:
    - # Heading 1
    - **bold text**
    - - bullet list
    - ```code block```
23. Verify formatting shows in WYSIWYG editor

**Test delete:**
24. Open a note, tap Delete
25. Confirm - note should be removed
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm --filter @k7notes/mobile type-check` passes
2. App starts without errors
3. All CRUD operations work (create, read, update, delete notes)
4. Folder navigation works with breadcrumbs
5. Search returns relevant results instantly
6. Move note changes folder correctly
7. Markdown renders correctly in 10tap-editor
8. Data persists across app restarts
</verification>

<success_criteria>
- NOTE-01: User can create, edit, and delete notes (markdown stored, WYSIWYG displayed)
- NOTE-02: User can organize notes in nested folders
- NOTE-03: User can move notes between folders
- NOTE-04: User can search across all note content with instant results
- NOTE-05: Markdown renders correctly (headers, lists, code blocks, bold, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-note-taking/02-06-SUMMARY.md`
</output>
