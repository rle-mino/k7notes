---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/api/package.json
  - apps/api/tsconfig.json
  - apps/api/.eslintrc.js
  - apps/api/nest-cli.json
  - apps/api/src/main.ts
  - apps/api/src/app.module.ts
  - apps/api/src/app.controller.ts
  - apps/api/src/db/index.ts
  - apps/api/src/db/schema.ts
  - apps/api/drizzle.config.ts
  - apps/api/.env.example
autonomous: true

# NOTE on BACK-03 (shared schema):
# The schema lives in apps/api/src/db/schema.ts for Phase 1.
# This is intentional - sharing via packages/db-schema is deferred to Phase 5 (Cloud Sync)
# when we need SQLite + PostgreSQL dual-database support. For now, the API owns the schema
# as the single source of truth. The mobile app will use API endpoints, not direct DB access.

must_haves:
  truths:
    - "NestJS server starts and responds to HTTP requests"
    - "Drizzle connects to PostgreSQL database"
    - "Health endpoint returns 200 OK"
  artifacts:
    - path: "apps/api/src/main.ts"
      provides: "NestJS entry point"
      contains: "NestFactory.create"
    - path: "apps/api/src/db/index.ts"
      provides: "Drizzle database connection"
      contains: "drizzle"
    - path: "apps/api/src/db/schema.ts"
      provides: "Database schema"
      contains: "pgTable"
  key_links:
    - from: "apps/api/src/app.module.ts"
      to: "apps/api/src/db/index.ts"
      via: "module import"
      pattern: "import.*db"
    - from: "apps/api/src/db/index.ts"
      to: "DATABASE_URL"
      via: "environment variable"
      pattern: "process\\.env\\.DATABASE_URL"
---

<objective>
Scaffold NestJS backend with Drizzle ORM and PostgreSQL connection.

Purpose: Creates the API server that will handle authentication, data storage, and business logic. Sets up the database layer with Drizzle ORM for type-safe queries.

Output: Running NestJS server with PostgreSQL connection via Drizzle, ready for authentication setup.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold NestJS application</name>
  <files>
    apps/api/package.json
    apps/api/tsconfig.json
    apps/api/.eslintrc.js
    apps/api/nest-cli.json
    apps/api/src/main.ts
    apps/api/src/app.module.ts
    apps/api/src/app.controller.ts
    apps/api/.env.example
  </files>
  <action>
Create the NestJS backend app:

1. Create apps/api/package.json:
   ```json
   {
     "name": "@k7notes/api",
     "version": "0.0.0",
     "private": true,
     "scripts": {
       "build": "nest build",
       "dev": "nest start --watch",
       "start": "node dist/main",
       "lint": "eslint \"src/**/*.ts\"",
       "type-check": "tsc --noEmit"
     },
     "dependencies": {
       "@nestjs/common": "^10.0.0",
       "@nestjs/core": "^10.0.0",
       "@nestjs/platform-express": "^10.0.0",
       "reflect-metadata": "^0.2.0",
       "rxjs": "^7.8.0"
     },
     "devDependencies": {
       "@k7notes/eslint-config": "workspace:*",
       "@k7notes/typescript-config": "workspace:*",
       "@nestjs/cli": "^10.0.0",
       "@types/node": "^20.0.0",
       "eslint": "^8.0.0",
       "typescript": "^5.0.0"
     }
   }
   ```

2. Create apps/api/tsconfig.json:
   ```json
   {
     "extends": "@k7notes/typescript-config/nestjs.json",
     "compilerOptions": {
       "baseUrl": ".",
       "paths": {
         "@/*": ["./src/*"]
       }
     },
     "include": ["src/**/*"],
     "exclude": ["node_modules", "dist"]
   }
   ```

3. Create apps/api/.eslintrc.js:
   ```javascript
   module.exports = {
     extends: ["@k7notes/eslint-config"],
     parserOptions: {
       project: "./tsconfig.json",
       tsconfigRootDir: __dirname
     },
     root: true
   };
   ```

4. Create apps/api/nest-cli.json:
   ```json
   {
     "$schema": "https://json.schemastore.org/nest-cli",
     "collection": "@nestjs/schematics",
     "sourceRoot": "src",
     "compilerOptions": {
       "deleteOutDir": true
     }
   }
   ```

5. Create apps/api/src/main.ts:
   ```typescript
   import { NestFactory } from "@nestjs/core";
   import { AppModule } from "./app.module";

   async function bootstrap() {
     // bodyParser: false is CRITICAL for better-auth (added in Plan 04)
     const app = await NestFactory.create(AppModule);

     app.enableCors({
       origin: [
         "http://localhost:8081", // Expo web
         "http://localhost:19006", // Expo web alt
         /^exp:\/\/.*/, // Expo dev
       ],
       credentials: true,
     });

     const port = process.env.PORT || 3000;
     await app.listen(port);
     console.log(`API running on http://localhost:${port}`);
   }
   bootstrap();
   ```

6. Create apps/api/src/app.module.ts:
   ```typescript
   import { Module } from "@nestjs/common";
   import { AppController } from "./app.controller";

   @Module({
     imports: [],
     controllers: [AppController],
     providers: [],
   })
   export class AppModule {}
   ```

7. Create apps/api/src/app.controller.ts:
   ```typescript
   import { Controller, Get } from "@nestjs/common";

   @Controller()
   export class AppController {
     @Get("health")
     health() {
       return { status: "ok", timestamp: new Date().toISOString() };
     }
   }
   ```

8. Create apps/api/.env.example:
   ```
   PORT=3000
   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/k7notes
   BASE_URL=http://localhost:3000
   ```

9. Run `pnpm install` from root to install dependencies.
  </action>
  <verify>
`pnpm --filter @k7notes/api type-check` passes.
`pnpm --filter @k7notes/api build` creates dist/ directory.
  </verify>
  <done>NestJS app scaffolded with health endpoint, extends shared configs.</done>
</task>

<task type="auto">
  <name>Task 2: Add Drizzle ORM with PostgreSQL connection</name>
  <files>
    apps/api/src/db/index.ts
    apps/api/src/db/schema.ts
    apps/api/drizzle.config.ts
    apps/api/package.json (update)
  </files>
  <action>
Set up Drizzle ORM for database access:

1. Update apps/api/package.json dependencies (add to existing):
   ```json
   {
     "dependencies": {
       "drizzle-orm": "^0.37.0",
       "pg": "^8.11.0",
       "dotenv": "^16.0.0"
     },
     "devDependencies": {
       "@types/pg": "^8.11.0",
       "drizzle-kit": "^0.28.0"
     },
     "scripts": {
       "db:generate": "drizzle-kit generate",
       "db:migrate": "drizzle-kit migrate",
       "db:push": "drizzle-kit push",
       "db:studio": "drizzle-kit studio"
     }
   }
   ```
   (Merge with existing package.json, don't replace)

2. Create apps/api/src/db/schema.ts:
   ```typescript
   import { pgTable, text, timestamp, uuid, boolean } from "drizzle-orm/pg-core";

   // better-auth will add user, session, account tables in Plan 04
   // For now, create a minimal schema to verify connection

   export const healthCheck = pgTable("health_check", {
     id: uuid("id").primaryKey().defaultRandom(),
     checkedAt: timestamp("checked_at").notNull().defaultNow(),
   });
   ```

3. Create apps/api/src/db/index.ts:
   ```typescript
   import { drizzle } from "drizzle-orm/node-postgres";
   import { Pool } from "pg";
   import * as schema from "./schema";

   const connectionString = process.env.DATABASE_URL;

   if (!connectionString) {
     throw new Error("DATABASE_URL environment variable is required");
   }

   const pool = new Pool({
     connectionString,
   });

   export const db = drizzle(pool, { schema });
   export { schema };
   ```

4. Create apps/api/drizzle.config.ts:
   ```typescript
   import "dotenv/config";
   import { defineConfig } from "drizzle-kit";

   export default defineConfig({
     schema: "./src/db/schema.ts",
     out: "./drizzle",
     dialect: "postgresql",
     dbCredentials: {
       url: process.env.DATABASE_URL!,
     },
   });
   ```

5. Update apps/api/src/main.ts to load dotenv at top:
   ```typescript
   import "dotenv/config";
   // ... rest of imports
   ```

6. Run `pnpm install` from root.

7. Create apps/api/.env (copy from .env.example, set real DATABASE_URL):
   - If PostgreSQL is local: postgresql://postgres:postgres@localhost:5432/k7notes
   - Ensure k7notes database exists (create with: createdb k7notes)

8. Run `pnpm --filter @k7notes/api db:push` to create tables.
  </action>
  <verify>
`pnpm --filter @k7notes/api db:push` completes without error (requires PostgreSQL running).
`pnpm --filter @k7notes/api type-check` passes.
  </verify>
  <done>Drizzle ORM configured with PostgreSQL connection, schema pushed to database.</done>
</task>

<task type="auto">
  <name>Task 3: Verify NestJS server starts and connects to database</name>
  <files>
    apps/api/src/app.controller.ts (update)
  </files>
  <action>
Add a database health check to verify the full stack:

1. Update apps/api/src/app.controller.ts:
   ```typescript
   import { Controller, Get } from "@nestjs/common";
   import { db, schema } from "./db";

   @Controller()
   export class AppController {
     @Get("health")
     health() {
       return { status: "ok", timestamp: new Date().toISOString() };
     }

     @Get("health/db")
     async healthDb() {
       try {
         // Insert and immediately delete a health check record
         const result = await db
           .insert(schema.healthCheck)
           .values({})
           .returning();

         return {
           status: "ok",
           database: "connected",
           testId: result[0].id,
           timestamp: new Date().toISOString()
         };
       } catch (error) {
         return {
           status: "error",
           database: "disconnected",
           error: error instanceof Error ? error.message : "Unknown error"
         };
       }
     }
   }
   ```

2. Start the server: `pnpm --filter @k7notes/api dev`

3. Test endpoints:
   - curl http://localhost:3000/health
   - curl http://localhost:3000/health/db
  </action>
  <verify>
`curl http://localhost:3000/health` returns {"status":"ok",...}
`curl http://localhost:3000/health/db` returns {"status":"ok","database":"connected",...}
  </verify>
  <done>NestJS server running with verified PostgreSQL connection via Drizzle.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @k7notes/api dev` starts server without errors
2. `curl http://localhost:3000/health` returns 200 with status: ok
3. `curl http://localhost:3000/health/db` returns 200 with database: connected
4. `pnpm --filter @k7notes/api type-check` passes
5. `pnpm --filter @k7notes/api lint` passes (or only style warnings)
</verification>

<success_criteria>
- NestJS app exists at apps/api/
- Server starts and listens on port 3000
- Health endpoint returns JSON response
- Drizzle connects to PostgreSQL successfully
- Database health check endpoint confirms connection
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
