---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - apps/api/package.json
  - apps/api/src/main.ts
  - apps/api/src/app.module.ts
  - apps/api/src/auth/auth.config.ts
  - apps/api/src/auth/auth.module.ts
  - apps/api/src/db/schema.ts
  - apps/mobile/package.json
  - apps/mobile/src/lib/auth.ts
  - apps/mobile/app/_layout.tsx
  - apps/mobile/app/(auth)/login.tsx
  - apps/mobile/app/(auth)/signup.tsx
autonomous: true

must_haves:
  truths:
    - "User can sign up with email and password"
    - "User can sign in with email and password"
    - "Session persists after app restart"
  artifacts:
    - path: "apps/api/src/auth/auth.config.ts"
      provides: "better-auth server configuration"
      contains: "betterAuth"
    - path: "apps/mobile/src/lib/auth.ts"
      provides: "better-auth client"
      contains: "createAuthClient"
    - path: "apps/api/src/db/schema.ts"
      provides: "User, session, account tables"
      contains: "user"
  key_links:
    - from: "apps/mobile/src/lib/auth.ts"
      to: "apps/api/src/auth"
      via: "HTTP to /api/auth/*"
      pattern: "baseURL"
    - from: "apps/api/src/auth/auth.config.ts"
      to: "apps/api/src/db"
      via: "drizzleAdapter"
      pattern: "drizzleAdapter.*db"
    - from: "apps/mobile/app/_layout.tsx"
      to: "apps/mobile/src/lib/auth.ts"
      via: "useSession hook"
      pattern: "authClient\\.useSession"
---

<objective>
Implement email/password authentication with better-auth on both backend and mobile.

Purpose: Delivers core authentication functionality (AUTH-01, AUTH-03). Users can create accounts and sign in, with sessions persisted securely using expo-secure-store.

Output: Working email/password signup and signin flows, session persistence across app restarts.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up better-auth on NestJS backend</name>
  <files>
    apps/api/package.json
    apps/api/src/main.ts
    apps/api/src/app.module.ts
    apps/api/src/auth/auth.config.ts
    apps/api/src/auth/auth.module.ts
    apps/api/src/db/schema.ts
  </files>
  <action>
Configure better-auth server with Drizzle adapter:

1. Update apps/api/package.json dependencies (merge with existing):
   ```json
   {
     "dependencies": {
       "better-auth": "^1.4.15",
       "@better-auth/expo": "^1.4.15",
       "@thallesp/nestjs-better-auth": "^1.3.8"
     }
   }
   ```
   Run `pnpm install` from root.

2. Generate better-auth schema. From apps/api/:
   ```bash
   npx @better-auth/cli generate --adapter drizzle --output src/db/auth-schema.ts
   ```

3. Update apps/api/src/db/schema.ts to include better-auth tables:
   ```typescript
   import { pgTable, text, timestamp, uuid, boolean } from "drizzle-orm/pg-core";

   // Better-auth tables (from generated auth-schema.ts)
   export const user = pgTable("user", {
     id: text("id").primaryKey(),
     name: text("name").notNull(),
     email: text("email").notNull().unique(),
     emailVerified: boolean("email_verified").notNull().default(false),
     image: text("image"),
     createdAt: timestamp("created_at").notNull().defaultNow(),
     updatedAt: timestamp("updated_at").notNull().defaultNow(),
   });

   export const session = pgTable("session", {
     id: text("id").primaryKey(),
     expiresAt: timestamp("expires_at").notNull(),
     token: text("token").notNull().unique(),
     createdAt: timestamp("created_at").notNull().defaultNow(),
     updatedAt: timestamp("updated_at").notNull().defaultNow(),
     ipAddress: text("ip_address"),
     userAgent: text("user_agent"),
     userId: text("user_id")
       .notNull()
       .references(() => user.id, { onDelete: "cascade" }),
   });

   export const account = pgTable("account", {
     id: text("id").primaryKey(),
     accountId: text("account_id").notNull(),
     providerId: text("provider_id").notNull(),
     userId: text("user_id")
       .notNull()
       .references(() => user.id, { onDelete: "cascade" }),
     accessToken: text("access_token"),
     refreshToken: text("refresh_token"),
     idToken: text("id_token"),
     accessTokenExpiresAt: timestamp("access_token_expires_at"),
     refreshTokenExpiresAt: timestamp("refresh_token_expires_at"),
     scope: text("scope"),
     password: text("password"),
     createdAt: timestamp("created_at").notNull().defaultNow(),
     updatedAt: timestamp("updated_at").notNull().defaultNow(),
   });

   export const verification = pgTable("verification", {
     id: text("id").primaryKey(),
     identifier: text("identifier").notNull(),
     value: text("value").notNull(),
     expiresAt: timestamp("expires_at").notNull(),
     createdAt: timestamp("created_at"),
     updatedAt: timestamp("updated_at"),
   });

   // App-specific tables (for future phases)
   export const healthCheck = pgTable("health_check", {
     id: uuid("id").primaryKey().defaultRandom(),
     checkedAt: timestamp("checked_at").notNull().defaultNow(),
   });
   ```

4. Create apps/api/src/auth/auth.config.ts:
   ```typescript
   import { betterAuth } from "better-auth";
   import { drizzleAdapter } from "better-auth/adapters/drizzle";
   import { expo } from "@better-auth/expo";
   import { db } from "../db";

   export const auth = betterAuth({
     database: drizzleAdapter(db, {
       provider: "pg",
     }),
     baseURL: process.env.BASE_URL || "http://localhost:3000",
     basePath: "/api/auth",
     trustedOrigins: [
       "k7notes://", // App deep link scheme
       "exp://", // Expo dev scheme
       "http://localhost:8081", // Expo web
       "http://localhost:19006", // Expo web alt
     ],
     emailAndPassword: {
       enabled: true,
       requireEmailVerification: false, // Simplify for v1
     },
     plugins: [expo()],
   });

   export type Auth = typeof auth;
   ```

5. Create apps/api/src/auth/auth.module.ts:
   ```typescript
   import { Module } from "@nestjs/common";
   import { AuthModule as BetterAuthModule } from "@thallesp/nestjs-better-auth";
   import { auth } from "./auth.config";

   @Module({
     imports: [
       BetterAuthModule.forRoot({
         auth,
         // Routes are handled by better-auth at /api/auth/*
       }),
     ],
     exports: [BetterAuthModule],
   })
   export class AuthModule {}
   ```

6. Update apps/api/src/main.ts - CRITICAL: disable bodyParser:
   ```typescript
   import "dotenv/config";
   import { NestFactory } from "@nestjs/core";
   import { AppModule } from "./app.module";

   async function bootstrap() {
     // bodyParser: false is CRITICAL for better-auth to read request bodies
     const app = await NestFactory.create(AppModule, {
       bodyParser: false,
     });

     app.enableCors({
       origin: [
         "http://localhost:8081",
         "http://localhost:19006",
         /^exp:\/\/.*/,
         /^k7notes:\/\/.*/,
       ],
       credentials: true,
     });

     const port = process.env.PORT || 3000;
     await app.listen(port);
     console.log(`API running on http://localhost:${port}`);
   }
   bootstrap();
   ```

7. Update apps/api/src/app.module.ts:
   ```typescript
   import { Module } from "@nestjs/common";
   import { AppController } from "./app.controller";
   import { AuthModule } from "./auth/auth.module";

   @Module({
     imports: [AuthModule],
     controllers: [AppController],
     providers: [],
   })
   export class AppModule {}
   ```

8. Push schema to database:
   ```bash
   pnpm --filter @k7notes/api db:push
   ```
  </action>
  <verify>
`pnpm --filter @k7notes/api db:push` succeeds (creates user, session, account, verification tables).
`pnpm --filter @k7notes/api dev` starts without errors.
`curl http://localhost:3000/api/auth/ok` returns a response (better-auth health).
  </verify>
  <done>better-auth configured on NestJS with Drizzle adapter and email/password enabled.</done>
</task>

<task type="auto">
  <name>Task 2: Set up better-auth client on Expo mobile</name>
  <files>
    apps/mobile/package.json
    apps/mobile/src/lib/auth.ts
    apps/mobile/app/_layout.tsx
  </files>
  <action>
Configure better-auth client with expo-secure-store:

1. Update apps/mobile/package.json (install new dependencies):
   ```bash
   cd apps/mobile
   npx expo install better-auth @better-auth/expo expo-secure-store
   ```

   This should add to dependencies:
   - better-auth
   - @better-auth/expo
   - expo-secure-store

2. Create apps/mobile/src/lib/auth.ts:
   ```typescript
   import { createAuthClient } from "better-auth/react";
   import { expoClient } from "@better-auth/expo/client";
   import * as SecureStore from "expo-secure-store";

   const API_URL = process.env.EXPO_PUBLIC_API_URL || "http://localhost:3000";

   export const authClient = createAuthClient({
     baseURL: API_URL,
     basePath: "/api/auth",
     plugins: [
       expoClient({
         scheme: "k7notes",
         storagePrefix: "k7notes_auth",
         storage: SecureStore,
       }),
     ],
   });

   // Export hooks and utilities for use in components
   export const { useSession, signIn, signUp, signOut } = authClient;

   // Type exports
   export type Session = typeof authClient.$Infer.Session;
   export type User = typeof authClient.$Infer.User;
   ```

3. Update apps/mobile/app/_layout.tsx to use auth state:
   ```tsx
   import { useEffect, useState } from "react";
   import { Stack } from "expo-router";
   import { StatusBar } from "expo-status-bar";
   import { View, ActivityIndicator, StyleSheet } from "react-native";
   import { authClient } from "@/lib/auth";

   export default function RootLayout() {
     const { data: session, isPending } = authClient.useSession();

     // Show loading while checking auth state
     if (isPending) {
       return (
         <View style={styles.loading}>
           <ActivityIndicator size="large" color="#007AFF" />
         </View>
       );
     }

     return (
       <>
         <StatusBar style="auto" />
         <Stack screenOptions={{ headerShown: false }}>
           {session ? (
             <Stack.Screen name="(app)" />
           ) : (
             <Stack.Screen name="(auth)" />
           )}
         </Stack>
       </>
     );
   }

   const styles = StyleSheet.create({
     loading: {
       flex: 1,
       justifyContent: "center",
       alignItems: "center",
       backgroundColor: "#fff",
     },
   });
   ```
  </action>
  <verify>
`pnpm --filter @k7notes/mobile type-check` passes.
App starts without errors: `pnpm --filter @k7notes/mobile dev`
  </verify>
  <done>better-auth client configured with SecureStore for session persistence.</done>
</task>

<task type="auto">
  <name>Task 3: Implement signup and signin screens</name>
  <files>
    apps/mobile/app/(auth)/login.tsx
    apps/mobile/app/(auth)/signup.tsx
    apps/mobile/app/(auth)/_layout.tsx
  </files>
  <action>
Create functional authentication screens:

1. Update apps/mobile/app/(auth)/_layout.tsx:
   ```tsx
   import { Stack } from "expo-router";

   export default function AuthLayout() {
     return (
       <Stack>
         <Stack.Screen
           name="login"
           options={{
             title: "Sign In",
             headerShown: true,
           }}
         />
         <Stack.Screen
           name="signup"
           options={{
             title: "Create Account",
             headerShown: true,
           }}
         />
       </Stack>
     );
   }
   ```

2. Update apps/mobile/app/(auth)/login.tsx:
   ```tsx
   import { useState } from "react";
   import {
     View,
     Text,
     TextInput,
     TouchableOpacity,
     StyleSheet,
     Alert,
     KeyboardAvoidingView,
     Platform,
   } from "react-native";
   import { Link } from "expo-router";
   import { authClient } from "@/lib/auth";

   export default function LoginScreen() {
     const [email, setEmail] = useState("");
     const [password, setPassword] = useState("");
     const [loading, setLoading] = useState(false);

     const handleSignIn = async () => {
       if (!email || !password) {
         Alert.alert("Error", "Please fill in all fields");
         return;
       }

       setLoading(true);
       try {
         const { error } = await authClient.signIn.email({
           email,
           password,
         });

         if (error) {
           Alert.alert("Sign In Failed", error.message || "Invalid credentials");
         }
         // Success: session state updates automatically via useSession hook
       } catch (err) {
         Alert.alert("Error", "Network error. Please try again.");
       } finally {
         setLoading(false);
       }
     };

     return (
       <KeyboardAvoidingView
         style={styles.container}
         behavior={Platform.OS === "ios" ? "padding" : "height"}
       >
         <View style={styles.content}>
           <Text style={styles.title}>K7Notes</Text>
           <Text style={styles.subtitle}>Sign in to continue</Text>

           <View style={styles.form}>
             <TextInput
               style={styles.input}
               placeholder="Email"
               value={email}
               onChangeText={setEmail}
               keyboardType="email-address"
               autoCapitalize="none"
               autoCorrect={false}
             />
             <TextInput
               style={styles.input}
               placeholder="Password"
               value={password}
               onChangeText={setPassword}
               secureTextEntry
               autoCapitalize="none"
             />

             <TouchableOpacity
               style={[styles.button, loading && styles.buttonDisabled]}
               onPress={handleSignIn}
               disabled={loading}
             >
               <Text style={styles.buttonText}>
                 {loading ? "Signing in..." : "Sign In"}
               </Text>
             </TouchableOpacity>
           </View>

           <View style={styles.divider}>
             <View style={styles.dividerLine} />
             <Text style={styles.dividerText}>or</Text>
             <View style={styles.dividerLine} />
           </View>

           <TouchableOpacity style={[styles.button, styles.googleButton]}>
             <Text style={styles.buttonText}>Sign in with Google</Text>
           </TouchableOpacity>

           <Link href="/(auth)/signup" asChild>
             <TouchableOpacity style={styles.linkButton}>
               <Text style={styles.linkText}>
                 Don't have an account? <Text style={styles.linkBold}>Sign up</Text>
               </Text>
             </TouchableOpacity>
           </Link>
         </View>
       </KeyboardAvoidingView>
     );
   }

   const styles = StyleSheet.create({
     container: {
       flex: 1,
       backgroundColor: "#fff",
     },
     content: {
       flex: 1,
       justifyContent: "center",
       padding: 20,
     },
     title: {
       fontSize: 32,
       fontWeight: "bold",
       textAlign: "center",
       marginBottom: 8,
     },
     subtitle: {
       fontSize: 16,
       color: "#666",
       textAlign: "center",
       marginBottom: 40,
     },
     form: {
       gap: 12,
     },
     input: {
       borderWidth: 1,
       borderColor: "#ddd",
       borderRadius: 8,
       padding: 16,
       fontSize: 16,
     },
     button: {
       backgroundColor: "#007AFF",
       padding: 16,
       borderRadius: 8,
       alignItems: "center",
       marginTop: 8,
     },
     buttonDisabled: {
       opacity: 0.6,
     },
     buttonText: {
       color: "#fff",
       fontSize: 16,
       fontWeight: "600",
     },
     googleButton: {
       backgroundColor: "#4285F4",
     },
     divider: {
       flexDirection: "row",
       alignItems: "center",
       marginVertical: 24,
     },
     dividerLine: {
       flex: 1,
       height: 1,
       backgroundColor: "#ddd",
     },
     dividerText: {
       marginHorizontal: 16,
       color: "#666",
     },
     linkButton: {
       marginTop: 24,
       alignItems: "center",
     },
     linkText: {
       color: "#666",
       fontSize: 14,
     },
     linkBold: {
       color: "#007AFF",
       fontWeight: "600",
     },
   });
   ```

3. Create apps/mobile/app/(auth)/signup.tsx:
   ```tsx
   import { useState } from "react";
   import {
     View,
     Text,
     TextInput,
     TouchableOpacity,
     StyleSheet,
     Alert,
     KeyboardAvoidingView,
     Platform,
   } from "react-native";
   import { Link } from "expo-router";
   import { authClient } from "@/lib/auth";

   export default function SignUpScreen() {
     const [name, setName] = useState("");
     const [email, setEmail] = useState("");
     const [password, setPassword] = useState("");
     const [loading, setLoading] = useState(false);

     const handleSignUp = async () => {
       if (!name || !email || !password) {
         Alert.alert("Error", "Please fill in all fields");
         return;
       }

       if (password.length < 8) {
         Alert.alert("Error", "Password must be at least 8 characters");
         return;
       }

       setLoading(true);
       try {
         const { error } = await authClient.signUp.email({
           name,
           email,
           password,
         });

         if (error) {
           Alert.alert("Sign Up Failed", error.message || "Could not create account");
         }
         // Success: user is automatically signed in, session updates via useSession
       } catch (err) {
         Alert.alert("Error", "Network error. Please try again.");
       } finally {
         setLoading(false);
       }
     };

     return (
       <KeyboardAvoidingView
         style={styles.container}
         behavior={Platform.OS === "ios" ? "padding" : "height"}
       >
         <View style={styles.content}>
           <Text style={styles.title}>Create Account</Text>
           <Text style={styles.subtitle}>Sign up to get started</Text>

           <View style={styles.form}>
             <TextInput
               style={styles.input}
               placeholder="Full Name"
               value={name}
               onChangeText={setName}
               autoCapitalize="words"
               autoCorrect={false}
             />
             <TextInput
               style={styles.input}
               placeholder="Email"
               value={email}
               onChangeText={setEmail}
               keyboardType="email-address"
               autoCapitalize="none"
               autoCorrect={false}
             />
             <TextInput
               style={styles.input}
               placeholder="Password (min 8 characters)"
               value={password}
               onChangeText={setPassword}
               secureTextEntry
               autoCapitalize="none"
             />

             <TouchableOpacity
               style={[styles.button, loading && styles.buttonDisabled]}
               onPress={handleSignUp}
               disabled={loading}
             >
               <Text style={styles.buttonText}>
                 {loading ? "Creating account..." : "Create Account"}
               </Text>
             </TouchableOpacity>
           </View>

           <Link href="/(auth)/login" asChild>
             <TouchableOpacity style={styles.linkButton}>
               <Text style={styles.linkText}>
                 Already have an account? <Text style={styles.linkBold}>Sign in</Text>
               </Text>
             </TouchableOpacity>
           </Link>
         </View>
       </KeyboardAvoidingView>
     );
   }

   const styles = StyleSheet.create({
     container: {
       flex: 1,
       backgroundColor: "#fff",
     },
     content: {
       flex: 1,
       justifyContent: "center",
       padding: 20,
     },
     title: {
       fontSize: 32,
       fontWeight: "bold",
       textAlign: "center",
       marginBottom: 8,
     },
     subtitle: {
       fontSize: 16,
       color: "#666",
       textAlign: "center",
       marginBottom: 40,
     },
     form: {
       gap: 12,
     },
     input: {
       borderWidth: 1,
       borderColor: "#ddd",
       borderRadius: 8,
       padding: 16,
       fontSize: 16,
     },
     button: {
       backgroundColor: "#007AFF",
       padding: 16,
       borderRadius: 8,
       alignItems: "center",
       marginTop: 8,
     },
     buttonDisabled: {
       opacity: 0.6,
     },
     buttonText: {
       color: "#fff",
       fontSize: 16,
       fontWeight: "600",
     },
     linkButton: {
       marginTop: 24,
       alignItems: "center",
     },
     linkText: {
       color: "#666",
       fontSize: 14,
     },
     linkBold: {
       color: "#007AFF",
       fontWeight: "600",
     },
   });
   ```
  </action>
  <verify>
App shows login screen with email/password fields.
Tapping "Sign up" navigates to signup screen.
Creating account with valid data succeeds (check backend logs).
After signup, app shows home screen (session active).
Restarting app preserves session (still shows home screen).
  </verify>
  <done>Email/password signup and signin implemented with session persistence (AUTH-01, AUTH-03).</done>
</task>

</tasks>

<verification>
1. Start backend: `pnpm --filter @k7notes/api dev`
2. Start mobile: `pnpm --filter @k7notes/mobile dev`
3. On login screen, tap "Sign up" link
4. Fill in name, email, password (8+ chars) and submit
5. App navigates to home screen (authenticated)
6. Close and reopen app - still shows home screen (session persisted)
7. Check database: `SELECT * FROM "user";` shows new user
</verification>

<success_criteria>
- better-auth configured on backend with Drizzle adapter
- better-auth client on mobile with SecureStore
- User can sign up with email/password (AUTH-01)
- User can sign in with email/password
- Session persists across app restart (AUTH-03)
- Login/signup screens are functional and styled
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
