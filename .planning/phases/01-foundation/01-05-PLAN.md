---
phase: 01-foundation
plan: 05
type: execute
wave: 4
depends_on: ["01-04"]
files_modified:
  - apps/api/src/auth/auth.config.ts
  - apps/api/.env
  - apps/mobile/package.json
  - apps/mobile/app.json
  - apps/mobile/app/(auth)/login.tsx
  - apps/mobile/app/(app)/home.tsx
  - apps/mobile/src/lib/auth.ts
autonomous: false
user_setup:
  - service: google-oauth
    why: "Google Sign-In requires OAuth credentials"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID (Web)"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID (Web)"
    dashboard_config:
      - task: "Create OAuth 2.0 credentials"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add redirect URIs"
        location: "OAuth client -> Authorized redirect URIs: http://localhost:3000/api/auth/callback/google"
      - task: "Enable Google+ API (if required)"
        location: "Google Cloud Console -> APIs & Services -> Library -> Google+ API"

must_haves:
  truths:
    - "User can sign in with Google OAuth"
    - "User can log out from any screen"
    - "After logout, user sees login screen"
  artifacts:
    - path: "apps/api/src/auth/auth.config.ts"
      provides: "Google OAuth provider config"
      contains: "google"
    - path: "apps/mobile/app/(app)/home.tsx"
      provides: "Logout button"
      contains: "signOut"
  key_links:
    - from: "apps/mobile/app/(auth)/login.tsx"
      to: "apps/api/src/auth"
      via: "signIn.social google"
      pattern: "signIn\\.social.*google"
    - from: "apps/mobile/app/(app)/home.tsx"
      to: "apps/mobile/src/lib/auth.ts"
      via: "signOut function"
      pattern: "authClient\\.signOut"
---

<objective>
Add Google OAuth sign-in and implement logout functionality across the app.

Purpose: Completes authentication requirements (AUTH-02, AUTH-04). Google OAuth provides convenient one-tap sign-in, and logout allows users to switch accounts or sign out for security.

Output: Working Google sign-in button, functional logout from home screen.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Google OAuth on backend</name>
  <files>
    apps/api/src/auth/auth.config.ts
    apps/api/.env
    apps/api/.env.example
  </files>
  <action>
Add Google OAuth provider to better-auth config:

1. Update apps/api/.env.example:
   ```
   PORT=3000
   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/k7notes
   BASE_URL=http://localhost:3000

   # Google OAuth (get from Google Cloud Console)
   GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
   GOOGLE_CLIENT_SECRET=your-client-secret
   ```

2. Update apps/api/src/auth/auth.config.ts:
   ```typescript
   import { betterAuth } from "better-auth";
   import { drizzleAdapter } from "better-auth/adapters/drizzle";
   import { expo } from "@better-auth/expo";
   import { db } from "../db";

   export const auth = betterAuth({
     database: drizzleAdapter(db, {
       provider: "pg",
     }),
     baseURL: process.env.BASE_URL || "http://localhost:3000",
     basePath: "/api/auth",
     trustedOrigins: [
       "k7notes://", // App deep link scheme
       "exp://", // Expo dev scheme
       "http://localhost:8081", // Expo web
       "http://localhost:19006", // Expo web alt
     ],
     emailAndPassword: {
       enabled: true,
       requireEmailVerification: false,
     },
     socialProviders: {
       google: {
         clientId: process.env.GOOGLE_CLIENT_ID!,
         clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
         // Request offline access to get refresh tokens
         accessType: "offline",
         // Always show account picker
         prompt: "select_account",
       },
     },
     plugins: [expo()],
   });

   export type Auth = typeof auth;
   ```

3. User must set up Google OAuth credentials:
   - Go to Google Cloud Console (https://console.cloud.google.com/)
   - Create a new project or select existing
   - Go to APIs & Services > Credentials
   - Create OAuth 2.0 Client ID (Web application)
   - Add Authorized redirect URI: http://localhost:3000/api/auth/callback/google
   - Copy Client ID and Client Secret to apps/api/.env

4. Restart the API server after adding credentials.
  </action>
  <verify>
API server starts without errors with Google credentials configured.
`curl http://localhost:3000/api/auth/ok` still returns success.
  </verify>
  <done>Google OAuth provider configured on backend.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Google Sign-In button on mobile</name>
  <files>
    apps/mobile/package.json
    apps/mobile/app.json
    apps/mobile/app/(auth)/login.tsx
    apps/mobile/src/lib/auth.ts
  </files>
  <action>
Add Google sign-in to mobile app:

1. Install additional Expo packages:
   ```bash
   cd apps/mobile
   npx expo install expo-web-browser expo-linking
   ```

2. Update apps/mobile/src/lib/auth.ts to add Google sign-in helper:
   ```typescript
   import { createAuthClient } from "better-auth/react";
   import { expoClient } from "@better-auth/expo/client";
   import * as SecureStore from "expo-secure-store";

   const API_URL = process.env.EXPO_PUBLIC_API_URL || "http://localhost:3000";

   export const authClient = createAuthClient({
     baseURL: API_URL,
     basePath: "/api/auth",
     plugins: [
       expoClient({
         scheme: "k7notes",
         storagePrefix: "k7notes_auth",
         storage: SecureStore,
       }),
     ],
   });

   // Export hooks and utilities
   export const { useSession, signIn, signUp, signOut } = authClient;

   // Google sign-in helper
   export const signInWithGoogle = async () => {
     return authClient.signIn.social({
       provider: "google",
       callbackURL: "/", // Redirect back to app root
     });
   };

   // Type exports
   export type Session = typeof authClient.$Infer.Session;
   export type User = typeof authClient.$Infer.User;
   ```

3. Update apps/mobile/app/(auth)/login.tsx to wire up Google button:
   ```tsx
   import { useState } from "react";
   import {
     View,
     Text,
     TextInput,
     TouchableOpacity,
     StyleSheet,
     Alert,
     KeyboardAvoidingView,
     Platform,
     ActivityIndicator,
   } from "react-native";
   import { Link } from "expo-router";
   import { authClient, signInWithGoogle } from "@/lib/auth";

   export default function LoginScreen() {
     const [email, setEmail] = useState("");
     const [password, setPassword] = useState("");
     const [loading, setLoading] = useState(false);
     const [googleLoading, setGoogleLoading] = useState(false);

     const handleSignIn = async () => {
       if (!email || !password) {
         Alert.alert("Error", "Please fill in all fields");
         return;
       }

       setLoading(true);
       try {
         const { error } = await authClient.signIn.email({
           email,
           password,
         });

         if (error) {
           Alert.alert("Sign In Failed", error.message || "Invalid credentials");
         }
       } catch (err) {
         Alert.alert("Error", "Network error. Please try again.");
       } finally {
         setLoading(false);
       }
     };

     const handleGoogleSignIn = async () => {
       setGoogleLoading(true);
       try {
         const { error } = await signInWithGoogle();

         if (error) {
           Alert.alert("Google Sign In Failed", error.message || "Could not sign in with Google");
         }
         // Success: session updates automatically
       } catch (err) {
         Alert.alert("Error", "Could not open Google sign-in. Please try again.");
       } finally {
         setGoogleLoading(false);
       }
     };

     return (
       <KeyboardAvoidingView
         style={styles.container}
         behavior={Platform.OS === "ios" ? "padding" : "height"}
       >
         <View style={styles.content}>
           <Text style={styles.title}>K7Notes</Text>
           <Text style={styles.subtitle}>Sign in to continue</Text>

           <View style={styles.form}>
             <TextInput
               style={styles.input}
               placeholder="Email"
               value={email}
               onChangeText={setEmail}
               keyboardType="email-address"
               autoCapitalize="none"
               autoCorrect={false}
             />
             <TextInput
               style={styles.input}
               placeholder="Password"
               value={password}
               onChangeText={setPassword}
               secureTextEntry
               autoCapitalize="none"
             />

             <TouchableOpacity
               style={[styles.button, loading && styles.buttonDisabled]}
               onPress={handleSignIn}
               disabled={loading || googleLoading}
             >
               {loading ? (
                 <ActivityIndicator color="#fff" />
               ) : (
                 <Text style={styles.buttonText}>Sign In</Text>
               )}
             </TouchableOpacity>
           </View>

           <View style={styles.divider}>
             <View style={styles.dividerLine} />
             <Text style={styles.dividerText}>or</Text>
             <View style={styles.dividerLine} />
           </View>

           <TouchableOpacity
             style={[styles.button, styles.googleButton, googleLoading && styles.buttonDisabled]}
             onPress={handleGoogleSignIn}
             disabled={loading || googleLoading}
           >
             {googleLoading ? (
               <ActivityIndicator color="#fff" />
             ) : (
               <Text style={styles.buttonText}>Sign in with Google</Text>
             )}
           </TouchableOpacity>

           <Link href="/(auth)/signup" asChild>
             <TouchableOpacity style={styles.linkButton}>
               <Text style={styles.linkText}>
                 Don't have an account? <Text style={styles.linkBold}>Sign up</Text>
               </Text>
             </TouchableOpacity>
           </Link>
         </View>
       </KeyboardAvoidingView>
     );
   }

   const styles = StyleSheet.create({
     container: {
       flex: 1,
       backgroundColor: "#fff",
     },
     content: {
       flex: 1,
       justifyContent: "center",
       padding: 20,
     },
     title: {
       fontSize: 32,
       fontWeight: "bold",
       textAlign: "center",
       marginBottom: 8,
     },
     subtitle: {
       fontSize: 16,
       color: "#666",
       textAlign: "center",
       marginBottom: 40,
     },
     form: {
       gap: 12,
     },
     input: {
       borderWidth: 1,
       borderColor: "#ddd",
       borderRadius: 8,
       padding: 16,
       fontSize: 16,
     },
     button: {
       backgroundColor: "#007AFF",
       padding: 16,
       borderRadius: 8,
       alignItems: "center",
       marginTop: 8,
     },
     buttonDisabled: {
       opacity: 0.6,
     },
     buttonText: {
       color: "#fff",
       fontSize: 16,
       fontWeight: "600",
     },
     googleButton: {
       backgroundColor: "#4285F4",
     },
     divider: {
       flexDirection: "row",
       alignItems: "center",
       marginVertical: 24,
     },
     dividerLine: {
       flex: 1,
       height: 1,
       backgroundColor: "#ddd",
     },
     dividerText: {
       marginHorizontal: 16,
       color: "#666",
     },
     linkButton: {
       marginTop: 24,
       alignItems: "center",
     },
     linkText: {
       color: "#666",
       fontSize: 14,
     },
     linkBold: {
       color: "#007AFF",
       fontWeight: "600",
     },
   });
   ```

Note: Google OAuth will open in a web browser and redirect back to the app.
For development, test on web first (press 'w' in Expo) where OAuth flows work best.
Native Google Sign-In (using @react-native-google-signin) requires a development build, not Expo Go.
  </action>
  <verify>
`pnpm --filter @k7notes/mobile type-check` passes.
App shows Google sign-in button on login screen.
Tapping Google button opens OAuth flow (may fail if credentials not configured yet - that's expected).
  </verify>
  <done>Google sign-in button added to login screen.</done>
</task>

<task type="auto">
  <name>Task 3: Implement logout functionality</name>
  <files>
    apps/mobile/app/(app)/home.tsx
  </files>
  <action>
Add logout to the home screen:

1. Update apps/mobile/app/(app)/home.tsx:
   ```tsx
   import { useState } from "react";
   import {
     View,
     Text,
     StyleSheet,
     TouchableOpacity,
     Alert,
     ActivityIndicator,
   } from "react-native";
   import { authClient } from "@/lib/auth";

   export default function HomeScreen() {
     const { data: session } = authClient.useSession();
     const [loggingOut, setLoggingOut] = useState(false);

     const handleLogout = async () => {
       setLoggingOut(true);
       try {
         await authClient.signOut();
         // Session clears automatically, _layout.tsx will redirect to auth
       } catch (err) {
         Alert.alert("Error", "Could not sign out. Please try again.");
         setLoggingOut(false);
       }
     };

     const confirmLogout = () => {
       Alert.alert(
         "Sign Out",
         "Are you sure you want to sign out?",
         [
           { text: "Cancel", style: "cancel" },
           { text: "Sign Out", style: "destructive", onPress: handleLogout },
         ]
       );
     };

     return (
       <View style={styles.container}>
         <Text style={styles.title}>Welcome to K7Notes</Text>

         {session?.user && (
           <View style={styles.userInfo}>
             <Text style={styles.userName}>{session.user.name}</Text>
             <Text style={styles.userEmail}>{session.user.email}</Text>
           </View>
         )}

         <Text style={styles.subtitle}>You are signed in!</Text>

         <Text style={styles.placeholder}>
           Note-taking features coming in Phase 2
         </Text>

         <TouchableOpacity
           style={[styles.logoutButton, loggingOut && styles.buttonDisabled]}
           onPress={confirmLogout}
           disabled={loggingOut}
         >
           {loggingOut ? (
             <ActivityIndicator color="#fff" />
           ) : (
             <Text style={styles.logoutText}>Sign Out</Text>
           )}
         </TouchableOpacity>
       </View>
     );
   }

   const styles = StyleSheet.create({
     container: {
       flex: 1,
       justifyContent: "center",
       alignItems: "center",
       padding: 20,
       backgroundColor: "#fff",
     },
     title: {
       fontSize: 24,
       fontWeight: "bold",
       marginBottom: 16,
     },
     userInfo: {
       alignItems: "center",
       marginBottom: 8,
     },
     userName: {
       fontSize: 18,
       fontWeight: "600",
       color: "#333",
     },
     userEmail: {
       fontSize: 14,
       color: "#666",
     },
     subtitle: {
       fontSize: 16,
       color: "#666",
       marginBottom: 40,
     },
     placeholder: {
       fontSize: 14,
       color: "#999",
       fontStyle: "italic",
       marginBottom: 40,
     },
     logoutButton: {
       backgroundColor: "#FF3B30",
       padding: 16,
       borderRadius: 8,
       paddingHorizontal: 32,
     },
     buttonDisabled: {
       opacity: 0.6,
     },
     logoutText: {
       color: "#fff",
       fontSize: 16,
       fontWeight: "600",
     },
   });
   ```
  </action>
  <verify>
Home screen shows user's name and email.
Logout button shows confirmation dialog.
After logout, app navigates to login screen.
Session is cleared (restarting app shows login screen).
  </verify>
  <done>Logout functionality implemented (AUTH-04).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication flow: email/password signup, email/password signin, Google OAuth signin, logout, session persistence</what-built>
  <how-to-verify>
1. Start backend: `pnpm --filter @k7notes/api dev`
2. Start mobile: `pnpm --filter @k7notes/mobile dev` (press 'w' for web)

**Test email/password flow:**
3. On login screen, tap "Sign up"
4. Create account with name, email, password (8+ chars)
5. After signup, should see home screen with your name/email
6. Tap "Sign Out" -> Confirm -> Should return to login
7. Sign in with the same email/password
8. Verify you see home screen again

**Test session persistence:**
9. While signed in, close browser tab
10. Re-open app at localhost:8081 (or restart Expo)
11. Should still be signed in (home screen, not login)

**Test Google OAuth (if credentials configured):**
12. Sign out first
13. Tap "Sign in with Google"
14. Complete Google OAuth flow
15. Should see home screen with Google account info

**Test logout:**
16. From home screen, tap "Sign Out"
17. Confirm logout
18. Should see login screen
19. Restart app - should still see login (session cleared)

If Google OAuth not configured yet, note that in approval - we can configure later.
  </how-to-verify>
  <resume-signal>Type "approved" if auth flow works, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Email signup creates user in database
2. Email signin works with created credentials
3. Google OAuth redirects to Google and back (when configured)
4. Session persists across app restart
5. Logout clears session and shows login screen
6. All auth flows work on web (iOS/Android similar but may need dev build for Google)
</verification>

<success_criteria>
- User can sign up with email/password (AUTH-01) - verified in Plan 04
- User can sign in with Google OAuth (AUTH-02)
- User session persists across app restarts (AUTH-03) - verified in Plan 04
- User can log out from any screen (AUTH-04)
- App shows user info on home screen
- Human has verified the complete auth flow works
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
