---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/mobile/package.json
  - apps/mobile/tsconfig.json
  - apps/mobile/app.json
  - apps/mobile/babel.config.js
  - apps/mobile/metro.config.js
  - apps/mobile/app/_layout.tsx
  - apps/mobile/app/index.tsx
  - apps/mobile/app/(auth)/_layout.tsx
  - apps/mobile/app/(auth)/login.tsx
  - apps/mobile/app/(app)/_layout.tsx
  - apps/mobile/app/(app)/home.tsx
  - apps/mobile/src/lib/api.ts
autonomous: true

must_haves:
  truths:
    - "Expo app starts on iOS simulator, Android emulator, and web"
    - "File-based routing works with Expo Router"
    - "App can make HTTP requests to backend API"
  artifacts:
    - path: "apps/mobile/app.json"
      provides: "Expo configuration"
      contains: "expo"
    - path: "apps/mobile/app/_layout.tsx"
      provides: "Root layout with navigation"
      contains: "Stack"
    - path: "apps/mobile/src/lib/api.ts"
      provides: "API client for backend"
      contains: "EXPO_PUBLIC_API_URL"
  key_links:
    - from: "apps/mobile/app/_layout.tsx"
      to: "apps/mobile/app/(auth)/_layout.tsx"
      via: "Expo Router file-based routing"
      pattern: "Stack"
    - from: "apps/mobile/src/lib/api.ts"
      to: "apps/api"
      via: "HTTP fetch"
      pattern: "fetch.*api"
---

<objective>
Scaffold Expo mobile app with React Native, Expo Router, and basic navigation structure.

Purpose: Creates the cross-platform mobile/web app that users interact with. Sets up the authentication flow structure that will be wired to better-auth in subsequent plans.

Output: Running Expo app on iOS, Android, and web with navigation skeleton (auth vs app routes).
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Expo app with Expo Router</name>
  <files>
    apps/mobile/package.json
    apps/mobile/tsconfig.json
    apps/mobile/app.json
    apps/mobile/babel.config.js
    apps/mobile/metro.config.js
    apps/mobile/.env.example
  </files>
  <action>
Create the Expo mobile app:

1. Navigate to apps/ directory and create mobile app using Expo:
   ```bash
   cd apps
   npx create-expo-app@latest mobile --template blank-typescript
   cd mobile
   ```

2. Replace apps/mobile/package.json with (keep expo version from create-expo-app):
   ```json
   {
     "name": "@k7notes/mobile",
     "version": "0.0.0",
     "private": true,
     "main": "expo-router/entry",
     "scripts": {
       "dev": "expo start",
       "dev:ios": "expo start --ios",
       "dev:android": "expo start --android",
       "dev:web": "expo start --web",
       "build": "expo export",
       "lint": "eslint app src --ext .ts,.tsx",
       "type-check": "tsc --noEmit"
     },
     "dependencies": {
       "expo": "~52.0.0",
       "expo-router": "~4.0.0",
       "expo-status-bar": "~2.0.0",
       "expo-linking": "~7.0.0",
       "expo-constants": "~17.0.0",
       "react": "18.3.1",
       "react-native": "0.76.5",
       "react-native-safe-area-context": "4.12.0",
       "react-native-screens": "~4.4.0",
       "react-native-web": "~0.19.13",
       "@expo/vector-icons": "^14.0.0"
     },
     "devDependencies": {
       "@babel/core": "^7.24.0",
       "@k7notes/typescript-config": "workspace:*",
       "@types/react": "~18.3.0",
       "eslint": "^8.0.0",
       "typescript": "^5.3.0"
     }
   }
   ```
   (Adjust versions to match what create-expo-app generated if different)

3. Create apps/mobile/tsconfig.json:
   ```json
   {
     "extends": "expo/tsconfig.base",
     "compilerOptions": {
       "strict": true,
       "baseUrl": ".",
       "paths": {
         "@/*": ["./src/*"]
       }
     },
     "include": ["**/*.ts", "**/*.tsx", ".expo/types/**/*.ts", "expo-env.d.ts"]
   }
   ```

4. Update apps/mobile/app.json:
   ```json
   {
     "expo": {
       "name": "K7Notes",
       "slug": "k7notes",
       "scheme": "k7notes",
       "version": "1.0.0",
       "orientation": "portrait",
       "icon": "./assets/icon.png",
       "userInterfaceStyle": "automatic",
       "newArchEnabled": true,
       "splash": {
         "image": "./assets/splash-icon.png",
         "resizeMode": "contain",
         "backgroundColor": "#ffffff"
       },
       "ios": {
         "bundleIdentifier": "com.k7notes.app",
         "supportsTablet": true
       },
       "android": {
         "package": "com.k7notes.app",
         "adaptiveIcon": {
           "foregroundImage": "./assets/adaptive-icon.png",
           "backgroundColor": "#ffffff"
         }
       },
       "web": {
         "bundler": "metro",
         "output": "single",
         "favicon": "./assets/favicon.png"
       },
       "plugins": ["expo-router"],
       "experiments": {
         "typedRoutes": true
       }
     }
   }
   ```

5. Create apps/mobile/babel.config.js:
   ```javascript
   module.exports = function (api) {
     api.cache(true);
     return {
       presets: ["babel-preset-expo"],
     };
   };
   ```

6. Create apps/mobile/metro.config.js:
   ```javascript
   // Learn more https://docs.expo.io/guides/customizing-metro
   const { getDefaultConfig } = require("expo/metro-config");

   /** @type {import('expo/metro-config').MetroConfig} */
   const config = getDefaultConfig(__dirname);

   // Expo SDK 52+ auto-detects monorepo - no manual config needed!
   // Do NOT add watchFolders or nodeModulesPaths

   module.exports = config;
   ```

7. Create apps/mobile/.env.example:
   ```
   EXPO_PUBLIC_API_URL=http://localhost:3000
   ```

8. Create apps/mobile/assets/ with placeholder images:
   - icon.png (1024x1024 app icon)
   - splash-icon.png (splash screen)
   - adaptive-icon.png (Android adaptive icon)
   - favicon.png (web favicon)
   (Use any placeholder PNGs for now - can be designed later)

9. Run from root: `pnpm install`
  </action>
  <verify>
`pnpm --filter @k7notes/mobile type-check` passes.
`ls apps/mobile/app.json` confirms file exists.
  </verify>
  <done>Expo app created with proper monorepo configuration.</done>
</task>

<task type="auto">
  <name>Task 2: Set up Expo Router navigation structure</name>
  <files>
    apps/mobile/app/_layout.tsx
    apps/mobile/app/index.tsx
    apps/mobile/app/(auth)/_layout.tsx
    apps/mobile/app/(auth)/login.tsx
    apps/mobile/app/(app)/_layout.tsx
    apps/mobile/app/(app)/home.tsx
  </files>
  <action>
Create the navigation structure with auth and app route groups:

1. Delete any existing App.tsx or index.tsx from create-expo-app.

2. Create apps/mobile/app/_layout.tsx:
   ```tsx
   import { Stack } from "expo-router";
   import { StatusBar } from "expo-status-bar";

   export default function RootLayout() {
     // Auth state will be managed here in Plan 04
     // For now, show the auth flow by default
     const isAuthenticated = false;

     return (
       <>
         <StatusBar style="auto" />
         <Stack screenOptions={{ headerShown: false }}>
           {isAuthenticated ? (
             <Stack.Screen name="(app)" />
           ) : (
             <Stack.Screen name="(auth)" />
           )}
         </Stack>
       </>
     );
   }
   ```

3. Create apps/mobile/app/index.tsx:
   ```tsx
   import { Redirect } from "expo-router";

   export default function Index() {
     // Redirect to login by default
     // Will be updated to check auth state in Plan 04
     return <Redirect href="/(auth)/login" />;
   }
   ```

4. Create apps/mobile/app/(auth)/_layout.tsx:
   ```tsx
   import { Stack } from "expo-router";

   export default function AuthLayout() {
     return (
       <Stack>
         <Stack.Screen
           name="login"
           options={{
             title: "Sign In",
             headerShown: true,
           }}
         />
       </Stack>
     );
   }
   ```

5. Create apps/mobile/app/(auth)/login.tsx:
   ```tsx
   import { View, Text, StyleSheet, TouchableOpacity } from "react-native";

   export default function LoginScreen() {
     return (
       <View style={styles.container}>
         <Text style={styles.title}>K7Notes</Text>
         <Text style={styles.subtitle}>Sign in to continue</Text>

         <View style={styles.buttonContainer}>
           <TouchableOpacity style={styles.button}>
             <Text style={styles.buttonText}>Sign in with Email</Text>
           </TouchableOpacity>

           <TouchableOpacity style={[styles.button, styles.googleButton]}>
             <Text style={styles.buttonText}>Sign in with Google</Text>
           </TouchableOpacity>
         </View>

         <Text style={styles.footer}>
           Don't have an account? Sign up
         </Text>
       </View>
     );
   }

   const styles = StyleSheet.create({
     container: {
       flex: 1,
       justifyContent: "center",
       alignItems: "center",
       padding: 20,
       backgroundColor: "#fff",
     },
     title: {
       fontSize: 32,
       fontWeight: "bold",
       marginBottom: 8,
     },
     subtitle: {
       fontSize: 16,
       color: "#666",
       marginBottom: 40,
     },
     buttonContainer: {
       width: "100%",
       gap: 12,
     },
     button: {
       backgroundColor: "#007AFF",
       padding: 16,
       borderRadius: 8,
       alignItems: "center",
     },
     googleButton: {
       backgroundColor: "#4285F4",
     },
     buttonText: {
       color: "#fff",
       fontSize: 16,
       fontWeight: "600",
     },
     footer: {
       marginTop: 40,
       color: "#666",
     },
   });
   ```

6. Create apps/mobile/app/(app)/_layout.tsx:
   ```tsx
   import { Stack } from "expo-router";

   export default function AppLayout() {
     return (
       <Stack>
         <Stack.Screen
           name="home"
           options={{
             title: "Home",
             headerShown: true,
           }}
         />
       </Stack>
     );
   }
   ```

7. Create apps/mobile/app/(app)/home.tsx:
   ```tsx
   import { View, Text, StyleSheet, TouchableOpacity } from "react-native";

   export default function HomeScreen() {
     return (
       <View style={styles.container}>
         <Text style={styles.title}>Welcome to K7Notes</Text>
         <Text style={styles.subtitle}>You are signed in!</Text>

         <TouchableOpacity style={styles.logoutButton}>
           <Text style={styles.logoutText}>Sign Out</Text>
         </TouchableOpacity>
       </View>
     );
   }

   const styles = StyleSheet.create({
     container: {
       flex: 1,
       justifyContent: "center",
       alignItems: "center",
       padding: 20,
       backgroundColor: "#fff",
     },
     title: {
       fontSize: 24,
       fontWeight: "bold",
       marginBottom: 8,
     },
     subtitle: {
       fontSize: 16,
       color: "#666",
       marginBottom: 40,
     },
     logoutButton: {
       backgroundColor: "#FF3B30",
       padding: 16,
       borderRadius: 8,
       paddingHorizontal: 32,
     },
     logoutText: {
       color: "#fff",
       fontSize: 16,
       fontWeight: "600",
     },
   });
   ```
  </action>
  <verify>
`pnpm --filter @k7notes/mobile type-check` passes.
`ls apps/mobile/app/` shows _layout.tsx, index.tsx, (auth), (app) directories.
  </verify>
  <done>Expo Router navigation structure created with auth and app route groups.</done>
</task>

<task type="auto">
  <name>Task 3: Create API client and verify app starts</name>
  <files>
    apps/mobile/src/lib/api.ts
    apps/mobile/.env
  </files>
  <action>
Create API client for backend communication:

1. Create apps/mobile/src/lib/api.ts:
   ```typescript
   const API_URL = process.env.EXPO_PUBLIC_API_URL || "http://localhost:3000";

   interface ApiResponse<T> {
     data?: T;
     error?: string;
   }

   async function fetchApi<T>(
     endpoint: string,
     options?: RequestInit
   ): Promise<ApiResponse<T>> {
     try {
       const response = await fetch(`${API_URL}${endpoint}`, {
         ...options,
         headers: {
           "Content-Type": "application/json",
           ...options?.headers,
         },
       });

       if (!response.ok) {
         const error = await response.text();
         return { error: error || `HTTP ${response.status}` };
       }

       const data = await response.json();
       return { data };
     } catch (error) {
       return {
         error: error instanceof Error ? error.message : "Network error",
       };
     }
   }

   export const api = {
     health: () => fetchApi<{ status: string; timestamp: string }>("/health"),
     healthDb: () =>
       fetchApi<{ status: string; database: string }>("/health/db"),
   };

   export { API_URL };
   ```

2. Create apps/mobile/.env (copy from .env.example):
   ```
   EXPO_PUBLIC_API_URL=http://localhost:3000
   ```

3. Update apps/mobile/app/(auth)/login.tsx to test API connection:
   Add at the top of the component:
   ```tsx
   import { useState, useEffect } from "react";
   import { api } from "@/lib/api";

   export default function LoginScreen() {
     const [apiStatus, setApiStatus] = useState<string>("Checking...");

     useEffect(() => {
       api.health().then((result) => {
         if (result.data) {
           setApiStatus(`API: ${result.data.status}`);
         } else {
           setApiStatus(`API Error: ${result.error}`);
         }
       });
     }, []);

     return (
       <View style={styles.container}>
         {/* ... existing content ... */}
         <Text style={styles.apiStatus}>{apiStatus}</Text>
       </View>
     );
   }
   ```

   Add to styles:
   ```tsx
   apiStatus: {
     position: "absolute",
     bottom: 40,
     color: "#999",
     fontSize: 12,
   },
   ```

4. Start the Expo app:
   - Create apps/mobile/.env with: EXPO_PUBLIC_API_URL=http://localhost:3000
   - Run: `pnpm --filter @k7notes/api dev` (start backend first)
   - Run: `pnpm --filter @k7notes/mobile dev`

5. Test on each platform:
   - Press 'w' for web
   - Press 'i' for iOS simulator (requires Xcode)
   - Press 'a' for Android emulator (requires Android Studio)
  </action>
  <verify>
App starts on at least one platform (web is easiest to test).
Login screen shows "API: ok" at the bottom (requires backend running).
No TypeScript errors: `pnpm --filter @k7notes/mobile type-check` passes.
  </verify>
  <done>Expo app running on all platforms with API connection verified.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @k7notes/mobile dev` starts Expo without errors
2. Web version (press 'w') shows login screen
3. Login screen displays "API: ok" when backend is running
4. Navigation structure exists: (auth) and (app) route groups
5. `pnpm --filter @k7notes/mobile type-check` passes
</verification>

<success_criteria>
- Expo app exists at apps/mobile/
- App starts on iOS, Android, and web from single codebase (PLAT-01, PLAT-02, PLAT-03)
- Expo Router file-based navigation works
- Auth flow skeleton exists (login screen)
- App flow skeleton exists (home screen)
- API client can communicate with backend
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
